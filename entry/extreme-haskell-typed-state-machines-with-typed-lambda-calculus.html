<!DOCTYPE HTML>
<html><head><title>Extreme Haskell: Typed State Machines with Typed Lambda Calculus · in Code</title><meta name="description" content="Weblog of Justin Le, covering various adventures in programming and explorations in the worlds of computation physics, and knowledge.
"><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><meta name="flattr:id" content="3p9jqr"><meta property="og:site_name" content="in Code"><meta property="og:description" content="I always say, inside every Haskeller there are two wolves, living on both ends of the Haskell Fancy Code Spectrum (HFCS). Are you going to write “simple Haskell”, using basic GHC 2010 tools and writing universal Haskell that every introductory course offers, trying to keep the code as immediately understandable and accessible? Or are you going to pile in all of the Haskell type system and evaluation tricks you can find and turn on all the extensions, and go full fancy? In my Seven Levels of Type Safety post, I described different extremes of type safety and fancy code. I talked about how writing effective code was finding the correct compromise for the level of communication and safety you need. But this is not that kind of blog post. This blog post is about what happens when you say “screw it, let’s go full fancy”? Let’s ignore the advice of the great Kirk Lazarus. Let’s go full fancy. Let’s write code that is so inscrutable, so much of a pain and torture to write, yet so undeniably useful that you can’t help but try to throw it in every single thing you write and will feel a gnawing emptiness in your soul until you do. Here’s one example: let’s write a type-safe method to specify your program as a series of states, with triggered transitions between them. A Type-Safe state machine graph using a type-safe lambda calculus. We want to specify this in a way that we can write once and it will  * Be interpretable in a type-safe way within Haskell * Be inspectable with visualizable control flow. * Be compilable to multiple actual backends, letting you run the same function under multiple implementations. This is all stuff I have been using in real life in my personal projects, where I’ve needed to write a specification of an algorithm that I can simulate in Haskell, generate graphical visualizations of, and also convert to multiple (purescript, dhall, C dialects) to unify algorithms and formulas across back-ends without writing them from scratch every time."><meta property="og:type" content="article"><meta property="og:title" content="Extreme Haskell: Typed State Machines with Typed Lambda Calculus"><meta property="og:image" content="https://blog.jle.im/img/site_logo.jpg"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://blog.jle.im/entry/extreme-haskell-typed-state-machines-with-typed-lambda-calculus.html"><meta name="twitter:card" content="summary"><meta name="twitter:creator:id" content="mstk"><link rel="author" href="https://plus.google.com/107705320197444500140"><link rel="alternate" type="application/rss+xml" title="in Code (RSS Feed)" href="http://feeds.feedburner.com/incodeblog"><link rel="canonical" href="https://blog.jle.im/entry/extreme-haskell-typed-state-machines-with-typed-lambda-calculus.html"><link href="https://blog.jle.im/favicon.ico" rel="shortcut icon"><link href="https://blog.jle.im/css/toast.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/font.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/main.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/page/entry.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/pygments.css" rel="stylesheet" type="text/css"><script type="text/javascript">var page_data = {};
var disqus_shortname='incode';
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-443711-8', 'jle.im');
ga('send', 'pageview');
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id="MathJax-script" async="" src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js"></script><script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5234d67a6b68dcd4"></script><script type="text/javascript" src="https://blog.jle.im/js/page/entry_toc.js"></script><script type="text/javascript" src="https://blog.jle.im/js/disqus_count.js"></script><script type="text/javascript" src="https://blog.jle.im/js/social.js"></script><script type="text/javascript" src="https://blog.jle.im/js/jquery/jquery.toc.js"></script><script type="text/javascript" src="https://blog.jle.im/purescript/entry.js"></script></head><body><div id="fb-root"><script>(function(d, s, id) {
 var js, fjs = d.getElementsByTagName(s)[0];
 if (d.getElementById(id)) return;
 js = d.createElement(s); js.id = id;
 js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=641852699171929";
 fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script></div><div id="header-container"><div id="navbar-container" class="tile"><nav id="navbar-content"><div class="nav-info"><h1 class="site-title"><a href="https://blog.jle.im/" class="nav-title">in Code</a></h1><span class="nav-author">Justin Le</span></div><ul class="nav-links"><li><a href="https://blog.jle.im/">home</a></li><li><a href="https://blog.jle.im/entries.html">archives</a></li><li><a href="https://cv.jle.im">cv</a></li><div class="clear"></div></ul></nav></div><div id="header-content"></div></div><div id="body-container" class="container"><div id="main-container" class="grid"><div class="entry-section unit span-grid" role="main"><article class="tile article"><header><div class="unposted-banner">Unposted entry</div><h1 id="title">Extreme Haskell: Typed State Machines with Typed Lambda Calculus</h1><p class="entry-info">by <a class="author" href="https://blog.jle.im/">Justin Le</a></p><p><span class="source-info"><a class="source-link" href="https://github.com/mstksg/inCode/tree/master/copy/entries/typed-sm-lc.md">Source</a><span class="info-separator"> &diams; </span><a class="source-link" href="https://github.com/mstksg/inCode/tree/gh-pages/entry/extreme-haskell-typed-state-machines-with-typed-lambda-calculus.md">Markdown</a><span class="info-separator"> &diams; </span><a class="source-link" href="https://blog.jle.im/entry/extreme-haskell-typed-state-machines-with-typed-lambda-calculus.tex">LaTeX</a><span class="info-separator"> &diams; </span></span>Posted in <a href="https://blog.jle.im/entries/category/@haskell.html" class="tag-a-category" title="Functional, pure, non-strict, statically and strongly typed, natively
compiled...really just the king of great languages.
">Haskell</a><span class="info-separator"> &diams; </span><a class="comment-link" href="#disqus_thread">Comments</a></p></header><hr><aside class="contents-container"><h5 id="contents-header">Contents</h5><div id="toc"></div></aside><div class="main-content copy-content"><p>I always say, inside every Haskeller there are two wolves, living on both ends of the Haskell Fancy Code Spectrum (HFCS). Are you going to write “simple Haskell”, using basic GHC 2010 tools and writing universal Haskell that every introductory course offers, trying to keep the code as immediately understandable and accessible? Or are you going to pile in all of the Haskell type system and evaluation tricks you can find and turn on all the extensions, and go full fancy?</p>
<p>In my <a href="https://blog.jle.im/entry/levels-of-type-safety-haskell-lists.html">Seven Levels of Type Safety</a> post, I described different extremes of type safety and fancy code. I talked about how writing effective code was finding the correct compromise for the level of communication and safety you need.</p>
<p>But this is not that kind of blog post. This blog post is about what happens when you say “screw it, let’s go full fancy”? Let’s ignore the advice of the great Kirk Lazarus. Let’s go full fancy. Let’s write code that is so inscrutable, so much of a pain and torture to write, yet so <em>undeniably useful</em> that you can’t help but try to throw it in every single thing you write and will feel a gnawing emptiness in your soul until you do.</p>
<p>Here’s one example: let’s write a type-safe method to specify your program as a series of states, with triggered transitions between them. A Type-Safe state machine graph using a type-safe lambda calculus. We want to specify this in a way that we can write once and it will</p>
<ol type="1">
<li>Be interpretable in a type-safe way within Haskell</li>
<li>Be inspectable with visualizable control flow.</li>
<li>Be compilable to multiple actual backends, letting you run the same function under multiple implementations.</li>
</ol>
<p>This is all stuff I have been using in real life in my personal projects, where I’ve needed to write a specification of an algorithm that I can simulate in Haskell, generate graphical visualizations of, and also convert to multiple (purescript, dhall, C dialects) to unify algorithms and formulas across back-ends without writing them from scratch every time.</p>
<p>Once you go down this road, everything you ever write will feel woefully unsafe and limited. And everything you will want to write will be woefully inscrutable by normal humans and borderline unusable. But such is the curse we all bear. Turn around now, you have been warned.</p>
<p>As Adam Neely asked in his <a href="https://www.youtube.com/watch?v=U8dcFhF0Dlk">AI Music Video Essay</a>, if you had trained all of AI on pre-jazz music, could AI have invented jazz? If you trained it on pre-80s hip-hop, could it have invented 80s hip-hop and its technological breakthroughs? If you trained AI on safe Haskell code, could it invent the monstrosity we are about to explore in this post?</p>
<p>All of the code here is <a href="https://github.com/mstksg/inCode/tree/master/code-samples/typed-sm-lc/flake.nix">available online</a>, and if you check out the repo and run <code>nix develop</code> you should be able to load it all in ghci:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd code-samples/typed-sm-lc</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> nix develop</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ghci</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">ghci</span><span class="op">&gt;</span> :load ExprStage1.hs</span></code></pre></div>
<h2 id="the-lambda-calculus">The Lambda Calculus</h2>
<h3 id="a-first-pass">A First Pass</h3>
<p>Let’s derive a way to express an algorithm or expression in Haskell that can be reified and analyzed within Haskell, and eventually be a form we can compile to different backends, interpret in Haskell, or generate Graphviz visualizations in.</p>
<p>One basic thing we can do is start with:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/typed-sm-lc/ExprStage1.hs#L8-L22</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Prim</span> <span class="ot">=</span> <span class="dt">PInt</span> <span class="dt">Int</span> <span class="op">|</span> <span class="dt">PBool</span> <span class="dt">Bool</span> <span class="op">|</span> <span class="dt">PString</span> <span class="dt">String</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Show</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Op</span> <span class="ot">=</span> <span class="dt">OPlus</span> <span class="op">|</span> <span class="dt">OTimes</span> <span class="op">|</span> <span class="dt">OLte</span> <span class="op">|</span> <span class="dt">OAnd</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Show</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Expr</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">EPrim</span> <span class="dt">Prim</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">EVar</span> <span class="dt">String</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">ELambda</span> <span class="dt">String</span> <span class="dt">Expr</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">EApply</span> <span class="dt">Expr</span> <span class="dt">Expr</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">EOp</span> <span class="dt">Op</span> <span class="dt">Expr</span> <span class="dt">Expr</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">ERecord</span> (<span class="dt">Map</span> <span class="dt">String</span> <span class="dt">Expr</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">EAccess</span> <span class="dt">Expr</span> <span class="dt">String</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Show</span>)</span></code></pre></div>
<p>And you can write <code>(\x -&gt; x * 3) 5</code> as:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/typed-sm-lc/ExprStage1.hs#L24-L25</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ot">fifteen ::</span> <span class="dt">Expr</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>fifteen <span class="ot">=</span> <span class="dt">ELambda</span> <span class="st">&quot;x&quot;</span> (<span class="dt">EOp</span> <span class="dt">OTimes</span> (<span class="dt">EVar</span> <span class="st">&quot;x&quot;</span>) (<span class="dt">EPrim</span> (<span class="dt">PInt</span> <span class="dv">3</span>))) <span class="ot">`EApply`</span> <span class="dt">EPrim</span> (<span class="dt">PInt</span> <span class="dv">5</span>)</span></code></pre></div>
<p>You can definitely easily render this in a graph, but what happens when you write a Haskell interpreter? How can you “evaluate” this to 15, within Haskell? What would the type even be? <code>eval :: Expr -&gt; Maybe Prim</code>? Maybe just <code>normalize :: Expr -&gt; Expr</code> and hope that the result is <code>Prim</code>?</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/typed-sm-lc/ExprStage1.hs#L27-L54</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ot">normalize ::</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">Expr</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>normalize env <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EPrim</span> p <span class="ot">-&gt;</span> <span class="dt">EPrim</span> p</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EVar</span> v <span class="ot">-&gt;</span> <span class="kw">case</span> M.lookup v env <span class="kw">of</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;Variable not defined&quot;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> x <span class="ot">-&gt;</span> normalize env x</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ELambda</span> n x <span class="ot">-&gt;</span> <span class="dt">ELambda</span> n x</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EApply</span> f x <span class="ot">-&gt;</span> <span class="kw">case</span> normalize env f <span class="kw">of</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ELambda</span> n u <span class="ot">-&gt;</span> normalize (M.insert n (normalize env x) env) u</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;Type error&quot;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EOp</span> o x y <span class="ot">-&gt;</span> <span class="kw">case</span> (normalize env x, normalize env y) <span class="kw">of</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">EPrim</span> x&#39;, <span class="dt">EPrim</span> y&#39;) <span class="ot">-&gt;</span> <span class="kw">case</span> (x&#39;, y&#39;) <span class="kw">of</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>      (<span class="dt">PInt</span> a, <span class="dt">PInt</span> b) <span class="ot">-&gt;</span> <span class="kw">case</span> o <span class="kw">of</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">OPlus</span> <span class="ot">-&gt;</span> <span class="dt">EPrim</span> (<span class="dt">PInt</span> (a <span class="op">+</span> b))</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">OTimes</span> <span class="ot">-&gt;</span> <span class="dt">EPrim</span> (<span class="dt">PInt</span> (a <span class="op">*</span> b))</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">OLte</span> <span class="ot">-&gt;</span> <span class="dt">EPrim</span> (<span class="dt">PBool</span> (a <span class="op">&lt;=</span> b))</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">OAnd</span> <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;Type error&quot;</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>      (<span class="dt">PBool</span> a, <span class="dt">PBool</span> b) <span class="ot">-&gt;</span> <span class="kw">case</span> o <span class="kw">of</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">OAnd</span> <span class="ot">-&gt;</span> <span class="dt">EPrim</span> (<span class="dt">PBool</span> (a <span class="op">&amp;&amp;</span> b))</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        _ <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;Type error&quot;</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>      _ <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;Type error&quot;</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    (x&#39;, y&#39;) <span class="ot">-&gt;</span> <span class="dt">EOp</span> o x&#39; y&#39;</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ERecord</span> xs <span class="ot">-&gt;</span> <span class="dt">ERecord</span> (M.map (normalize env) xs)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EAccess</span> e k <span class="ot">-&gt;</span> <span class="kw">case</span> normalize env e <span class="kw">of</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ERecord</span> xs <span class="ot">-&gt;</span> <span class="kw">case</span> M.lookup k xs <span class="kw">of</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Just</span> v <span class="ot">-&gt;</span> normalize env v</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;Field not found&quot;</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;Type error&quot;</span></span></code></pre></div>
<p>This would properly evaluate:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> normalize fifteen</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="dt">EPrim</span> (<span class="dt">PInt</span> <span class="dv">15</span>)</span></code></pre></div>
<p>Let’s say this is 5% fancy. We used recursive types, used <code>Map</code> to look things up efficiently.</p>
<p>But this isn’t type-safe…we have undefined branches still. We could make the entire thing monadic by returning <code>Maybe</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/typed-sm-lc/ExprStage2.hs#L27-L55</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ot">normalize ::</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">Expr</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Expr</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>normalize env <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EPrim</span> p <span class="ot">-&gt;</span> <span class="fu">pure</span> (<span class="dt">EPrim</span> p)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EVar</span> v <span class="ot">-&gt;</span> M.lookup v env <span class="op">&gt;&gt;=</span> normalize env</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ELambda</span> n x <span class="ot">-&gt;</span> <span class="fu">pure</span> (<span class="dt">ELambda</span> n x)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EApply</span> f x <span class="ot">-&gt;</span> normalize env f <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ELambda</span> n u <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>      x&#39; <span class="ot">&lt;-</span> normalize env x</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>      normalize (M.insert n x&#39; env) u</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    f&#39; <span class="ot">-&gt;</span> <span class="dt">EApply</span> f&#39; <span class="op">&lt;$&gt;</span> normalize env x</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EOp</span> o x y <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    u <span class="ot">&lt;-</span> normalize env x</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    v <span class="ot">&lt;-</span> normalize env y</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> (u, v) <span class="kw">of</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>      (<span class="dt">EPrim</span> x&#39;, <span class="dt">EPrim</span> y&#39;) <span class="ot">-&gt;</span> <span class="kw">case</span> (x&#39;, y&#39;) <span class="kw">of</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        (<span class="dt">PInt</span> a, <span class="dt">PInt</span> b) <span class="ot">-&gt;</span> <span class="kw">case</span> o <span class="kw">of</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>          <span class="dt">OPlus</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> (<span class="dt">EPrim</span> (<span class="dt">PInt</span> (a <span class="op">+</span> b)))</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>          <span class="dt">OTimes</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> (<span class="dt">EPrim</span> (<span class="dt">PInt</span> (a <span class="op">*</span> b)))</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>          <span class="dt">OLte</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> (<span class="dt">EPrim</span> (<span class="dt">PBool</span> (a <span class="op">&lt;=</span> b)))</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>          <span class="dt">OAnd</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        (<span class="dt">PBool</span> a, <span class="dt">PBool</span> b) <span class="ot">-&gt;</span> <span class="kw">case</span> o <span class="kw">of</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>          <span class="dt">OAnd</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> (<span class="dt">EPrim</span> (<span class="dt">PBool</span> (a <span class="op">&amp;&amp;</span> b)))</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>          _ <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        _ <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>      (x&#39;, y&#39;) <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">EOp</span> o x&#39; y&#39;</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ERecord</span> xs <span class="ot">-&gt;</span> <span class="dt">ERecord</span> <span class="op">&lt;$&gt;</span> <span class="fu">traverse</span> (normalize env) xs</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EAccess</span> e k <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ERecord</span> xs <span class="ot">&lt;-</span> normalize env e</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    M.lookup k xs</span></code></pre></div>
<p>This kind of works if you remember to thread everything through <code>Maybe</code> (or <code>Either</code>) or what have you. But this is not ideal. You should be able to know, at compile-time, that your <code>Expr</code> is valid. After all, you want to be able to create one “valid” <code>Expr</code>, and run it at every context. It’s utterly useless to you if every single time you used an <code>Expr</code>, you had to manually handle the <code>Nothing</code> case. Your diagram generator, your Haskell runner, your code generator, will always be in <code>Either</code> even though you know your <code>Expr</code> is valid, via tests or something.</p>
<p>This is maybe 10% fancy. We used <code>Maybe</code>/<code>Either</code> to prevent runtime exceptions, but didn’t actually get rid of any runtime <em>errors</em>.</p>
<p>No, this is not okay and unacceptable. We should be able to verify in the types if an <code>Expr</code> is valid.</p>
<h3 id="first-layer-of-types">First Layer of Types</h3>
<p>The next step you’ll see in posts online is to add a phantom index type to <code>Expr</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/typed-sm-lc/ExprStage3.hs#L14-L48</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="kw">data</span> <span class="dt">Ty</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">TInt</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">TBool</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">TString</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">TRecord</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Ty</span> <span class="op">:-&gt;</span> <span class="dt">Ty</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">STy</span><span class="ot"> ::</span> <span class="dt">Ty</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">STInt</span><span class="ot"> ::</span> <span class="dt">STy</span> <span class="dt">TInt</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">STBool</span><span class="ot"> ::</span> <span class="dt">STy</span> <span class="dt">TBool</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">STString</span><span class="ot"> ::</span> <span class="dt">STy</span> <span class="dt">TString</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">STRecord</span><span class="ot"> ::</span> <span class="dt">STy</span> <span class="dt">TRecord</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">STFun</span><span class="ot"> ::</span> <span class="dt">STy</span> a <span class="ot">-&gt;</span> <span class="dt">STy</span> b <span class="ot">-&gt;</span> <span class="dt">STy</span> (a <span class="op">:-&gt;</span> b)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Prim</span><span class="ot"> ::</span> <span class="dt">Ty</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">PInt</span><span class="ot"> ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Prim</span> <span class="dt">TInt</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">PBool</span><span class="ot"> ::</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">Prim</span> <span class="dt">TBool</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">PString</span><span class="ot"> ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Prim</span> <span class="dt">TString</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Op</span><span class="ot"> ::</span> <span class="dt">Ty</span> <span class="ot">-&gt;</span> <span class="dt">Ty</span> <span class="ot">-&gt;</span> <span class="dt">Ty</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="dt">OPlus</span><span class="ot"> ::</span> <span class="dt">Op</span> <span class="dt">TInt</span> <span class="dt">TInt</span> <span class="dt">TInt</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">OTimes</span><span class="ot"> ::</span> <span class="dt">Op</span> <span class="dt">TInt</span> <span class="dt">TInt</span> <span class="dt">TInt</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">OLte</span><span class="ot"> ::</span> <span class="dt">Op</span> <span class="dt">TInt</span> <span class="dt">TInt</span> <span class="dt">TBool</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">OAnd</span><span class="ot"> ::</span> <span class="dt">Op</span> <span class="dt">TBool</span> <span class="dt">TBool</span> <span class="dt">TBool</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Expr</span><span class="ot"> ::</span> <span class="dt">Ty</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EPrim</span><span class="ot"> ::</span> <span class="dt">Prim</span> t <span class="ot">-&gt;</span> <span class="dt">Expr</span> t</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EVar</span><span class="ot"> ::</span> <span class="dt">STy</span> t <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> t</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ELambda</span><span class="ot"> ::</span> <span class="dt">STy</span> a <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> b <span class="ot">-&gt;</span> <span class="dt">Expr</span> (a <span class="op">:-&gt;</span> b)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EApply</span><span class="ot"> ::</span> <span class="dt">Expr</span> (a <span class="op">:-&gt;</span> b) <span class="ot">-&gt;</span> <span class="dt">Expr</span> a <span class="ot">-&gt;</span> <span class="dt">Expr</span> b</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EOp</span><span class="ot"> ::</span> <span class="dt">Op</span> a b c <span class="ot">-&gt;</span> <span class="dt">Expr</span> a <span class="ot">-&gt;</span> <span class="dt">Expr</span> b <span class="ot">-&gt;</span> <span class="dt">Expr</span> c</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ERecord</span><span class="ot"> ::</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">SomeExpr</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> <span class="dt">TRecord</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EAccess</span><span class="ot"> ::</span> <span class="dt">STy</span> t <span class="ot">-&gt;</span> <span class="dt">Expr</span> <span class="dt">TRecord</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> t</span></code></pre></div>
<p>Here we use <code>-XTypeData</code> to define a data kind, <code>Ty</code> is a kind with types <code>TInt :: Ty</code>, <code>TBool :: Ty</code>, etc.</p>
<p>So now <code>Expr a</code> evaluates to an <code>a</code>, which is either our domain’s <code>Int</code>, our domain’s <code>Bool</code>, or our domain’s <code>String</code>. At least, now, it is impossible to create an <code>Expr</code> that doesn’t type check:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/typed-sm-lc/ExprStage3.hs#L50-L54</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ot">fifteen ::</span> <span class="dt">Expr</span> <span class="dt">TInt</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>fifteen <span class="ot">=</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EApply</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">ELambda</span> <span class="dt">STInt</span> <span class="st">&quot;x&quot;</span> (<span class="dt">EOp</span> <span class="dt">OTimes</span> (<span class="dt">EVar</span> <span class="dt">STInt</span> <span class="st">&quot;x&quot;</span>) (<span class="dt">EPrim</span> (<span class="dt">PInt</span> <span class="dv">3</span>))))</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">EPrim</span> (<span class="dt">PInt</span> <span class="dv">5</span>))</span></code></pre></div>
<p>We also need a <a href="https://blog.jle.im/entries/series/+introduction-to-singletons.html">singleton</a> for our <code>Ty</code> type, <code>STy</code>…this makes a whole lot of things simpler. Usually when you have a data kind, you can try to avoid singletons but a lot of times you’re just delaying the inevitable. In this case our lambda is “typed”, <code>ELambda STInt "x"</code>, so it binds a variable of type <code>Int</code> with name <code>x</code>.</p>
<p>Overall, I’ll say this is about 50% fancy. Anything with GADTs will be a significant bump. But you might see the problem here: <code>EVar STInt "x"</code>. <code>x</code> might not be defined, and it also might not have the correct type. Soooo yes, we still have issues here.</p>
<p>But now at least we can write <code>eval</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/typed-sm-lc/ExprStage3.hs#L56-L132</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">EValue</span><span class="ot"> ::</span> <span class="dt">Ty</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EVInt</span><span class="ot"> ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">EValue</span> <span class="dt">TInt</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EVBool</span><span class="ot"> ::</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">EValue</span> <span class="dt">TBool</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EVString</span><span class="ot"> ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">EValue</span> <span class="dt">TString</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EVRecord</span><span class="ot"> ::</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">SomeValue</span> <span class="ot">-&gt;</span> <span class="dt">EValue</span> <span class="dt">TRecord</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EVFun</span><span class="ot"> ::</span> (<span class="dt">EValue</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">EValue</span> b)) <span class="ot">-&gt;</span> <span class="dt">EValue</span> (a <span class="op">:-&gt;</span> b)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">SomeValue</span> <span class="kw">where</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">SomeValue</span><span class="ot"> ::</span> <span class="dt">STy</span> t <span class="ot">-&gt;</span> <span class="dt">EValue</span> t <span class="ot">-&gt;</span> <span class="dt">SomeValue</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="ot">sameTy ::</span> <span class="dt">STy</span> a <span class="ot">-&gt;</span> <span class="dt">STy</span> b <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (a <span class="op">:~:</span> b)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>sameTy <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">STInt</span> <span class="ot">-&gt;</span> \<span class="kw">case</span> <span class="dt">STInt</span> <span class="ot">-&gt;</span> <span class="dt">Just</span> <span class="dt">Refl</span>; _ <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">STBool</span> <span class="ot">-&gt;</span> \<span class="kw">case</span> <span class="dt">STBool</span> <span class="ot">-&gt;</span> <span class="dt">Just</span> <span class="dt">Refl</span>; _ <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">STString</span> <span class="ot">-&gt;</span> \<span class="kw">case</span> <span class="dt">STString</span> <span class="ot">-&gt;</span> <span class="dt">Just</span> <span class="dt">Refl</span>; _ <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">STRecord</span> <span class="ot">-&gt;</span> \<span class="kw">case</span> <span class="dt">STRecord</span> <span class="ot">-&gt;</span> <span class="dt">Just</span> <span class="dt">Refl</span>; _ <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">STFun</span> a b <span class="ot">-&gt;</span> \<span class="kw">case</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">STFun</span> c d <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Refl</span> <span class="ot">&lt;-</span> sameTy a c</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Refl</span> <span class="ot">&lt;-</span> sameTy b d</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Just</span> <span class="dt">Refl</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="ot">eval ::</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">SomeValue</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> t <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">EValue</span> t)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>eval env <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EPrim</span> (<span class="dt">PInt</span> n) <span class="ot">-&gt;</span> <span class="fu">pure</span> (<span class="dt">EVInt</span> n)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EPrim</span> (<span class="dt">PBool</span> b) <span class="ot">-&gt;</span> <span class="fu">pure</span> (<span class="dt">EVBool</span> b)</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EPrim</span> (<span class="dt">PString</span> s) <span class="ot">-&gt;</span> <span class="fu">pure</span> (<span class="dt">EVString</span> s)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EVar</span> t v <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">SomeValue</span> t&#39; v&#39; <span class="ot">&lt;-</span> M.lookup v env</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Refl</span> <span class="ot">&lt;-</span> sameTy t t&#39;</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> v&#39;</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ELambda</span> ta n body <span class="ot">-&gt;</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> <span class="op">$</span> <span class="dt">EVFun</span> <span class="op">$</span> \x <span class="ot">-&gt;</span> eval (M.insert n (<span class="dt">SomeValue</span> ta x) env) body</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EApply</span> f x <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    <span class="dt">EVFun</span> g <span class="ot">&lt;-</span> eval env f</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    x&#39; <span class="ot">&lt;-</span> eval env x</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    g x&#39;</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EOp</span> o x y <span class="ot">-&gt;</span> <span class="kw">case</span> o <span class="kw">of</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    <span class="dt">OPlus</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>      <span class="dt">EVInt</span> a <span class="ot">&lt;-</span> eval env x</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>      <span class="dt">EVInt</span> b <span class="ot">&lt;-</span> eval env y</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pure</span> (<span class="dt">EVInt</span> (a <span class="op">+</span> b))</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="dt">OTimes</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>      <span class="dt">EVInt</span> a <span class="ot">&lt;-</span> eval env x</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>      <span class="dt">EVInt</span> b <span class="ot">&lt;-</span> eval env y</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pure</span> (<span class="dt">EVInt</span> (a <span class="op">*</span> b))</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    <span class="dt">OLte</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>      <span class="dt">EVInt</span> a <span class="ot">&lt;-</span> eval env x</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>      <span class="dt">EVInt</span> b <span class="ot">&lt;-</span> eval env y</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pure</span> (<span class="dt">EVBool</span> (a <span class="op">&lt;=</span> b))</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>    <span class="dt">OAnd</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>      <span class="dt">EVBool</span> a <span class="ot">&lt;-</span> eval env x</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>      <span class="dt">EVBool</span> b <span class="ot">&lt;-</span> eval env y</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pure</span> (<span class="dt">EVBool</span> (a <span class="op">&amp;&amp;</span> b))</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ERecord</span> xs <span class="ot">-&gt;</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>    <span class="dt">EVRecord</span> <span class="op">&lt;$&gt;</span> <span class="fu">traverse</span> evalField xs</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EAccess</span> t e k <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>    <span class="dt">EVRecord</span> xs <span class="ot">&lt;-</span> eval env e</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>    <span class="dt">SomeValue</span> t&#39; v&#39; <span class="ot">&lt;-</span> M.lookup k xs</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Refl</span> <span class="ot">&lt;-</span> sameTy t t&#39;</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> v&#39;</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>    evalField (<span class="dt">SomeExpr</span> t v) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>      v&#39; <span class="ot">&lt;-</span> eval env v</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pure</span> (<span class="dt">SomeValue</span> t v&#39;)</span></code></pre></div>
<p>What did we gain here? We have a type-safe <code>eval</code> now that will create a value of the type we want. But we still have the same errors when looking at variables: variables can still not be defined, or be defined as the wrong type.</p>
<p>So, again, we cannot create an <code>Expr</code> that must be sensible and well-formed to compile. We still have to deal with <em>most</em> of the same errors. This is noble, but clearly not good enough. We have to go deeper.</p>
<h3 id="type-safe-environments">Type-Safe Environments</h3>
<p>In order to have <code>Var</code> be type-safe, the environment itself needs to be a part of the <code>Expr</code> type, and you should only be able to use <code>Var</code> if the <code>Expr</code> enforces it. <code>ELambda</code> would, therefore, introduce the new variable to the environment.</p>
<p>We’ll have:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/typed-sm-lc/ExprStage4.hs#L44-L59</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Expr</span><span class="ot"> ::</span> [(<span class="dt">Symbol</span>, <span class="dt">Ty</span>)] <span class="ot">-&gt;</span> <span class="dt">Ty</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> (<span class="op">:::</span>) l a <span class="ot">=</span> &#39;(l, a)</span></code></pre></div>
<p>So a value of type <code>Expr '["x" ::: TInt, "y" ::: TBool]</code> is an expression with free variables <code>x</code> of type <code>Int</code> and a <code>y</code> of type <code>Bool</code>.</p>
<p><code>ELambda</code> would therefore take a <code>Expr</code> with a free variable and turn it into an <code>Expr</code> of a function type: (and <code>KnownSymbol</code> instance so that we can debug print the variable name)</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/typed-sm-lc/ExprStage4.hs#L62-L66</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ELambda</span><span class="ot"> ::</span> <span class="dt">KnownSymbol</span> n <span class="ot">=&gt;</span> <span class="dt">Expr</span> (n <span class="op">:::</span> a &#39;<span class="op">:</span> vs) b <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs (a <span class="op">:-&gt;</span> b)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EApply</span><span class="ot"> ::</span> <span class="dt">Expr</span> vs (a <span class="op">:-&gt;</span> b) <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs a <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs b</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EOp</span><span class="ot"> ::</span> <span class="dt">Op</span> a b c <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs a <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs b <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs c</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ERecord</span><span class="ot"> ::</span> <span class="dt">Rec</span> (<span class="dt">ExprField</span> vs) as <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs (<span class="dt">TRecord</span> as)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EAccess</span><span class="ot"> ::</span> <span class="dt">KnownSymbol</span> l <span class="ot">=&gt;</span> <span class="dt">Expr</span> vs (<span class="dt">TRecord</span> as) <span class="ot">-&gt;</span> <span class="dt">Index</span> as (l <span class="op">:::</span> a) <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs a</span></code></pre></div>
<p>So how do we implement <code>Var</code>? We have to gate it on whether or not the free variable is available in the environment. For that, we can use <code>Index</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/typed-sm-lc/ExprStage4.hs#L31-L33</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Index</span><span class="ot"> ::</span> [k] <span class="ot">-&gt;</span> k <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">IZ</span><span class="ot"> ::</span> <span class="dt">Index</span> (x &#39;<span class="op">:</span> xs) x</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">IS</span><span class="ot"> ::</span> <span class="dt">Index</span> xs x <span class="ot">-&gt;</span> <span class="dt">Index</span> (y &#39;<span class="op">:</span> xs) x</span></code></pre></div>
<p>I have this in [functor-products][], but it’s also <code>CoRec Proxy</code> from [vinyl][] or <code>NP Proxy</code> from [sop-core][]. You can reason about this like axioms: <code>Index as a</code> means that <code>a</code> is an item in <code>as</code>, which is either <code>a</code> being at the start of the list (<code>IZ</code>) or <code>a</code> being within the tail (<code>IS</code>).</p>
<p>[functor-products][]: https://hackage.haskell.org/package/functor-products [vinyl]: https://hackage.haskell.org/package/vinyl [sop-core]: https://hackage.haskell.org/package/sop-core</p>
<p>For example, we have values <code>IZ :: Index '[a,b,c] a</code>, <code>IS IZ :: Index '[a,b,c] b</code>, and <code>IS (IS IZ) :: Index '[a,b,c] c</code>. So, if we require <code>Var</code> to take an <code>Index</code>, we require it to indicate something that <em>is</em> inside the <code>Expr</code>’s free variable list and at that given index:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/typed-sm-lc/ExprStage4.hs#L61-L66</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EVar</span><span class="ot"> ::</span> <span class="dt">Index</span> vs (n <span class="op">:::</span> t) <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs t</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ELambda</span><span class="ot"> ::</span> <span class="dt">KnownSymbol</span> n <span class="ot">=&gt;</span> <span class="dt">Expr</span> (n <span class="op">:::</span> a &#39;<span class="op">:</span> vs) b <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs (a <span class="op">:-&gt;</span> b)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EApply</span><span class="ot"> ::</span> <span class="dt">Expr</span> vs (a <span class="op">:-&gt;</span> b) <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs a <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs b</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EOp</span><span class="ot"> ::</span> <span class="dt">Op</span> a b c <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs a <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs b <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs c</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ERecord</span><span class="ot"> ::</span> <span class="dt">Rec</span> (<span class="dt">ExprField</span> vs) as <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs (<span class="dt">TRecord</span> as)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EAccess</span><span class="ot"> ::</span> <span class="dt">KnownSymbol</span> l <span class="ot">=&gt;</span> <span class="dt">Expr</span> vs (<span class="dt">TRecord</span> as) <span class="ot">-&gt;</span> <span class="dt">Index</span> as (l <span class="op">:::</span> a) <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs a</span></code></pre></div>
<p>So it is legal to have <code>EVar IZ :: Expr '["x" ::: TInt, "y" ::: TBool] TInt</code>, and also it is automatically inferred to be a <code>TInt</code>. But we could <em>not</em> write <code>EVar IZ :: Expr '[] TInt</code>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/typed-sm-lc/ExprStage4.hs#L59-L88</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Expr</span><span class="ot"> ::</span> [(<span class="dt">Symbol</span>, <span class="dt">Ty</span>)] <span class="ot">-&gt;</span> <span class="dt">Ty</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EPrim</span><span class="ot"> ::</span> <span class="dt">Prim</span> t <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs t</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EVar</span><span class="ot"> ::</span> <span class="dt">Index</span> vs (n <span class="op">:::</span> t) <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs t</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ELambda</span><span class="ot"> ::</span> <span class="dt">KnownSymbol</span> n <span class="ot">=&gt;</span> <span class="dt">Expr</span> (n <span class="op">:::</span> a &#39;<span class="op">:</span> vs) b <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs (a <span class="op">:-&gt;</span> b)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EApply</span><span class="ot"> ::</span> <span class="dt">Expr</span> vs (a <span class="op">:-&gt;</span> b) <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs a <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs b</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EOp</span><span class="ot"> ::</span> <span class="dt">Op</span> a b c <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs a <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs b <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs c</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ERecord</span><span class="ot"> ::</span> <span class="dt">Rec</span> (<span class="dt">ExprField</span> vs) as <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs (<span class="dt">TRecord</span> as)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EAccess</span><span class="ot"> ::</span> <span class="dt">KnownSymbol</span> l <span class="ot">=&gt;</span> <span class="dt">Expr</span> vs (<span class="dt">TRecord</span> as) <span class="ot">-&gt;</span> <span class="dt">Index</span> as (l <span class="op">:::</span> a) <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs a</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="ot">eLambda ::</span> <span class="kw">forall</span> n <span class="ot">-&gt;</span> <span class="dt">KnownSymbol</span> n <span class="ot">=&gt;</span> <span class="dt">Expr</span> (n <span class="op">:::</span> a &#39;<span class="op">:</span> vs) b <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs (a <span class="op">:-&gt;</span> b)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>eLambda n x <span class="ot">=</span> <span class="dt">ELambda</span> <span class="op">@</span>n x</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="ot">fifteen ::</span> <span class="dt">Expr</span> &#39;[] <span class="dt">TInt</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>fifteen <span class="ot">=</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EApply</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    (eLambda <span class="st">&quot;x&quot;</span> (<span class="dt">EOp</span> <span class="dt">OTimes</span> (<span class="dt">EVar</span> <span class="dt">IZ</span>) (<span class="dt">EPrim</span> (<span class="dt">PInt</span> <span class="dv">3</span>))))</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">EPrim</span> (<span class="dt">PInt</span> <span class="dv">5</span>))</span></code></pre></div>
<p>In GHC 9.12 we can write <code>eLambda</code> using <code>RequiredTypeArguments</code> and so can pass the type variable as a string literal, <code>eLambda "x"</code> but we can’t yet put this directly in <code>ELambda</code> for some reason.</p>
<p>Note that this is sometimes done using straight <a href="https://en.wikipedia.org/wiki/De_Bruijn_index">De Bruijn indices</a>: <code>Expr :: [Ty] -&gt; Type</code>, so we don’t use any names but just the direct index, but the point of this exercise is to be <em>borderline</em> unbearable to write, and <em>not</em> to be <em>actually</em> unbearable to write.</p>
<p>To actually write <em>eval</em> now, we need to have a type-safe environment to store these variables, and for this we can use <code>Rec</code> (from [vinyl][]) or <code>NP</code> from [sop-core]:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/typed-sm-lc/ExprStage4.hs#L27-L118</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Rec</span><span class="ot"> ::</span> (k <span class="ot">-&gt;</span> <span class="dt">Type</span>) <span class="ot">-&gt;</span> [k] <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">RNil</span><span class="ot"> ::</span> <span class="dt">Rec</span> f &#39;[]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="ot">  (:&amp;) ::</span> f x <span class="ot">-&gt;</span> <span class="dt">Rec</span> f xs <span class="ot">-&gt;</span> <span class="dt">Rec</span> f (x &#39;<span class="op">:</span> xs)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="ot">indexRec ::</span> <span class="dt">Index</span> xs x <span class="ot">-&gt;</span> <span class="dt">Rec</span> f xs <span class="ot">-&gt;</span> f x</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>indexRec <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">IZ</span> <span class="ot">-&gt;</span> \(x <span class="op">:&amp;</span> _) <span class="ot">-&gt;</span> x</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">IS</span> i <span class="ot">-&gt;</span> \(_ <span class="op">:&amp;</span> xs) <span class="ot">-&gt;</span> indexRec i xs</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="ot">eval ::</span> <span class="dt">Rec</span> <span class="dt">EValueField</span> vs <span class="ot">-&gt;</span> <span class="dt">Expr</span> vs t <span class="ot">-&gt;</span> <span class="dt">EValue</span> t</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>eval env <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EPrim</span> (<span class="dt">PInt</span> n) <span class="ot">-&gt;</span> <span class="dt">EVInt</span> n</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EPrim</span> (<span class="dt">PBool</span> b) <span class="ot">-&gt;</span> <span class="dt">EVBool</span> b</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EPrim</span> (<span class="dt">PString</span> s) <span class="ot">-&gt;</span> <span class="dt">EVString</span> s</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EVar</span> i <span class="ot">-&gt;</span> <span class="kw">case</span> indexRec i env <span class="kw">of</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">EVField</span> v <span class="ot">-&gt;</span> v</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ELambda</span> body <span class="ot">-&gt;</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">EVFun</span> <span class="op">$</span> \x <span class="ot">-&gt;</span> eval (<span class="dt">EVField</span> x <span class="op">:&amp;</span> env) body</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EApply</span> f x <span class="ot">-&gt;</span> <span class="kw">case</span> eval env f <span class="kw">of</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">EVFun</span> g <span class="ot">-&gt;</span> g (eval env x)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EOp</span> o x y <span class="ot">-&gt;</span> <span class="kw">case</span> (o, eval env x, eval env y) <span class="kw">of</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">OPlus</span>, <span class="dt">EVInt</span> a, <span class="dt">EVInt</span> b) <span class="ot">-&gt;</span> <span class="dt">EVInt</span> (a <span class="op">+</span> b)</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">OTimes</span>, <span class="dt">EVInt</span> a, <span class="dt">EVInt</span> b) <span class="ot">-&gt;</span> <span class="dt">EVInt</span> (a <span class="op">*</span> b)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">OLte</span>, <span class="dt">EVInt</span> a, <span class="dt">EVInt</span> b) <span class="ot">-&gt;</span> <span class="dt">EVBool</span> (a <span class="op">&lt;=</span> b)</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">OAnd</span>, <span class="dt">EVBool</span> a, <span class="dt">EVBool</span> b) <span class="ot">-&gt;</span> <span class="dt">EVBool</span> (a <span class="op">&amp;&amp;</span> b)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ERecord</span> xs <span class="ot">-&gt;</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">EVRecord</span> <span class="op">$</span> mapRec (\(<span class="dt">EField</span> x) <span class="ot">-&gt;</span> <span class="dt">EVField</span> (eval env x)) xs</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">EAccess</span> e i <span class="ot">-&gt;</span> <span class="kw">case</span> eval env e <span class="kw">of</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">EVRecord</span> xs <span class="ot">-&gt;</span> <span class="kw">case</span> indexRec i xs <span class="kw">of</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>      <span class="dt">EVField</span> v <span class="ot">-&gt;</span> v</span></code></pre></div>
<h2 id="the-state-machine">The State Machine</h2></div><footer><hr><div class="copy-content"><p>Hi, thanks for reading! You can reach me via email at <a href="mailto:justin@jle.im" class="email">justin@jle.im</a>, or at twitter at <a href="https://twitter.com/mstk">@mstk</a>! This post and all others are published under the <a href="https://creativecommons.org/licenses/by-nc-nd/3.0/">CC-BY-NC-ND 3.0</a> license. Corrections and edits via pull request are welcome and encouraged at <a href="https://github.com/mstksg/inCode">the source repository</a>.</p>
<p>If you feel inclined, or this post was particularly helpful for you, why not consider <a href="https://www.patreon.com/justinle/overview">supporting me on Patreon</a>, or a <a href="bitcoin:3D7rmAYgbDnp4gp4rf22THsGt74fNucPDU">BTC donation</a>? :)</p></div><div class="clear"></div><ul class="entry-series"></ul><ul class="tag-list"><li><a href="https://blog.jle.im/entries/tagged/dependent-types.html" class="tag-a-tag">#dependent types</a></li><li><a href="https://blog.jle.im/entries/tagged/functional-programming.html" class="tag-a-tag">#functional programming</a></li><li><a href="https://blog.jle.im/entries/tagged/haskell.html" class="tag-a-tag">#haskell</a></li><li><a href="https://blog.jle.im/entries/tagged/singletons.html" class="tag-a-tag">#singletons</a></li><li><a href="https://blog.jle.im/entries/tagged/types.html" class="tag-a-tag">#types</a></li><li><a href="https://blog.jle.im/entries/category/@haskell.html" class="tag-a-category">@HASKELL</a></li></ul><aside class="social-buttons"><div class="addthis_toolbox addthis_default_style addthis-buttons"><a class="addthis_button_facebook_like" fb:like:layout="button_count"></a><a class="addthis_button_tweet"></a><a class="addthis_button_google_plusone" g:plusone:size="medium"></a><a class="addthis_counter addthis_pill_style"></a></div><div class="custom-social-buttons"><div class="custom-social-button"><a href="https://www.reddit.com/submit" onclick="window.location = &#39;https://www.reddit.com/submit?url=&#39;+ encodeURIComponent(window.location); return false"><img src="https://www.reddit.com/static/spreddit7.gif" alt="submit to reddit"></a></div></div></aside><nav class="next-prev-links"><ul><li class="next-entry-link">(Next) <a href="https://blog.jle.im/entry/introducing-in-code.html">Introducing &quot;in Code&quot;!</a> &rarr;</li></ul></nav></footer></article><div class="post-entry"><div class="tile"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://blog.jle.im/entry/extreme-haskell-typed-state-machines-with-typed-lambda-calculus.html';
    this.page.identifier = 'typed-sm-lc';
};
(function() {
    var d = document, s = d.createElement('script');
    s.src = '//incode.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a><br></noscript><a href="http://disqus.com" class="dsq-brlink">Comments powered by <span class="logo-disqus">Disqus</span></a></div></div></div></div></div><div id="footer-container"><div id="footer-content"><div class="tile"><div class="footer-copyright">&copy; 2020 Justin Le <span class="license-link">(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/" class="license">CC-BY-NC-ND 3.0</a>)</span></div><div class="footer-follow social-follows"><ul class="social-follows-list"><li><ul class="social-follows-list-social"><li><a class="social-follow-twitter" title="Follow me on Twitter!" href="https://twitter.com/intent/user?user_id=mstk" onclick="window.open(
  &#39;http://twitter.com/intent/user?user_id=907281&#39;,
  &#39;facebook-share-dialog&#39;,
  &#39;width=550,height=520&#39;);
return false;
">Twitter</a></li><li><a class="social-follow-github" title="Fork me on Github!" href="https://github.com/mstksg">Github</a></li><li><a class="social-follow-twitch" title="Watch me on Twitch!" href="https://www.twitch.tv/justin_l">Twitch</a></li><li><a class="social-follow-patreon" title="Support me on Patreon!" href="https://www.patreon.com/justinle/overview">Patreon</a></li><li><a class="social-follow-gplus" title="Add me on Google+!" href="https://plus.google.com/+JustinLe">Google+</a></li><li><a class="social-follow-keybase" title="Track me on Keybase!" href="https://keybase.io/mstksg">Keybase</a></li><li><a class="social-follow-linkedin" title="Connect with me on LinkedIn!" href="https://linkedin.com/in/lejustin">LinkedIn</a></li><li><a class="social-follow-bitcoin" title="Donate via bitcoin!" href="bitcoin:3D7rmAYgbDnp4gp4rf22THsGt74fNucPDU">Bitcoin</a></li></ul></li><li><ul class="social-follows-list-site"><li><a class="social-follow-rss" title="Subscribe to my RSS Feed!" href="http://feeds.feedburner.com/incodeblog">RSS</a></li><li><a class="social-follow-email" title="Subscribe to the mailing list!" href="https://feedburner.google.com/fb/a/mailverify?loc=en_US&amp;uri=incodeblog">Mailing list</a></li></ul></li></ul></div></div></div></div></body></html>