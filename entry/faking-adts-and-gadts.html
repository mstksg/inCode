<!DOCTYPE HTML>
<html><head><title>Faking ADTs and GADTs in Languages That Shouldn&#39;t Have Them · in Code</title><meta name="description" content="Weblog of Justin Le, covering various adventures in programming and explorations in the worlds of computation physics, and knowledge.
"><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><meta name="flattr:id" content="3p9jqr"><meta property="og:site_name" content="in Code"><meta property="og:description" content="Haskell is the world’s best programming language, but let’s face the harsh reality that a lot of times in life you’ll have to write in other programming languages. But alas you have been fully Haskell-brained and lost all ability to program unless it is type-directed, you don’t even know how to start writing a program without imagining its shape as a type first. Well, fear not. The foundational theory behind Algebraic Data Types and Generalized Algebraic Data Types (ADTs and GADTs) are so fundamental that they’ll fit (somewhat) seamlessly into whatever language you’re forced to write. After all, if they can fit profunctor optics in Microsoft’s Java code, the sky’s the limit! This is an “April Fools” joke in the tradition of my previous one in some of these ways that we are going to twist these other languages might seem unconventional or possibly ill-advised… but also the title is definitely a lie: these languages definitely should have them! :D"><meta property="og:type" content="article"><meta property="og:title" content="Faking ADTs and GADTs in Languages That Shouldn&#39;t Have Them"><meta property="og:image" content="https://blog.jle.im/img/site_logo.jpg"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://blog.jle.im/entry/faking-adts-and-gadts.html"><meta name="twitter:card" content="summary"><meta name="twitter:creator:id" content="mstk"><link rel="author" href="https://plus.google.com/107705320197444500140"><link rel="alternate" type="application/rss+xml" title="in Code (RSS Feed)" href="http://feeds.feedburner.com/incodeblog"><link rel="canonical" href="https://blog.jle.im/entry/faking-adts-and-gadts.html"><link href="https://blog.jle.im/favicon.ico" rel="shortcut icon"><link href="https://blog.jle.im/css/toast.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/font.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/main.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/page/entry.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/pygments.css" rel="stylesheet" type="text/css"><script type="text/javascript">var page_data = {};
var disqus_shortname='incode';
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-443711-8', 'jle.im');
ga('send', 'pageview');
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id="MathJax-script" async="" src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js"></script><script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5234d67a6b68dcd4"></script><script type="text/javascript" src="https://blog.jle.im/js/page/entry_toc.js"></script><script type="text/javascript" src="https://blog.jle.im/js/disqus_count.js"></script><script type="text/javascript" src="https://blog.jle.im/js/social.js"></script><script type="text/javascript" src="https://blog.jle.im/js/jquery/jquery.toc.js"></script><script type="text/javascript" src="https://blog.jle.im/purescript/entry.js"></script></head><body><div id="fb-root"><script>(function(d, s, id) {
 var js, fjs = d.getElementsByTagName(s)[0];
 if (d.getElementById(id)) return;
 js = d.createElement(s); js.id = id;
 js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=641852699171929";
 fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script></div><div id="header-container"><div id="navbar-container" class="tile"><nav id="navbar-content"><div class="nav-info"><h1 class="site-title"><a href="https://blog.jle.im/" class="nav-title">in Code</a></h1><span class="nav-author">Justin Le</span></div><ul class="nav-links"><li><a href="https://blog.jle.im/">home</a></li><li><a href="https://blog.jle.im/entries.html">archives</a></li><li><a href="https://cv.jle.im">cv</a></li><div class="clear"></div></ul></nav></div><div id="header-content"></div></div><div id="body-container" class="container"><div id="main-container" class="grid"><div class="entry-section unit span-grid" role="main"><article class="tile article"><header><h1 id="title">Faking ADTs and GADTs in Languages That Shouldn&#39;t Have Them</h1><p class="entry-info">by <a class="author" href="https://blog.jle.im/">Justin Le</a><span class="info-separator"> &diams; </span><time datetime="2025-04-01T10:29:41Z" pubdate="" class="pubdate">Tuesday April 1, 2025</time></p><p><span class="source-info"><a class="source-link" href="https://github.com/mstksg/inCode/tree/master/copy/entries/faking-adts-and-gadts.md">Source</a><span class="info-separator"> &diams; </span><a class="source-link" href="https://github.com/mstksg/inCode/tree/gh-pages/entry/faking-adts-and-gadts.md">Markdown</a><span class="info-separator"> &diams; </span><a class="source-link" href="https://blog.jle.im/entry/faking-adts-and-gadts.tex">LaTeX</a><span class="info-separator"> &diams; </span></span>Posted in <a href="https://blog.jle.im/entries/category/@haskell.html" class="tag-a-category" title="Functional, pure, non-strict, statically and strongly typed, natively
compiled...really just the king of great languages.
">Haskell</a><span class="info-separator"> &diams; </span><a class="comment-link" href="#disqus_thread">Comments</a></p></header><hr><aside class="contents-container"><h5 id="contents-header">Contents</h5><div id="toc"></div></aside><div class="main-content copy-content"><p>Haskell is the world’s best programming language<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, but let’s face the harsh reality that a lot of times in life you’ll have to write in other programming languages. But alas you have been fully <a href="https://x.com/kmett/status/1844812186608099463">Haskell-brained</a> and lost all ability to program unless it is type-directed, you don’t even know how to start writing a program without imagining its shape as a type first.</p>
<p>Well, fear not. The foundational theory behind Algebraic Data Types and Generalized Algebraic Data Types (ADTs and GADTs) are so fundamental that they’ll fit (somewhat) seamlessly into whatever language you’re forced to write. After all, if they can fit <a href="https://www.reddit.com/r/haskell/comments/9m2o5r/digging_reveals_profunctor_optics_in_mineacraft/">profunctor optics in Microsoft’s Java code</a>, the sky’s the limit!</p>
<p>This is an “April Fools” joke in the tradition of <a href="https://blog.jle.im/entry/verified-instances-in-haskell.html">my previous one</a> in some of these ways that we are going to twist these other languages might seem unconventional or possibly ill-advised… but also the title is definitely a lie: these languages definitely <em>should</em> have them! :D</p>
<h2 id="normal-adts">Normal ADTs</h2>
<p>As a reminder, algebraic Data Types (ADTs) are products and sums; that’s why they’re algebraic, after all!</p>
<h3 id="product-types">Product Types</h3>
<p>Products are just immutable structs, which pretty much every language supports — as long as you’re able to make sure they are never mutated.</p>
<p>Structs in <code>c</code>, for example, look like:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> timestamp<span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> amount<span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Transaction<span class="op">;</span></span></code></pre></div>
<p>But you’ll need proper immutable API for it:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>Transaction createTransaction<span class="op">(</span><span class="dt">uint32_t</span> timestamp<span class="op">,</span> <span class="dt">double</span> amount<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(</span>Transaction<span class="op">){</span> timestamp<span class="op">,</span> amount<span class="op">};</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="dt">uint32_t</span> getTimestamp<span class="op">(</span><span class="dt">const</span> Transaction<span class="op">*</span> t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> t<span class="op">-&gt;</span>timestamp<span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> getAmount<span class="op">(</span><span class="dt">const</span> Transaction<span class="op">*</span> t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> t<span class="op">-&gt;</span>amount<span class="op">;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>Transaction setTimestamp<span class="op">(</span><span class="dt">const</span> Transaction<span class="op">*</span> t<span class="op">,</span> <span class="dt">uint32_t</span> timestamp<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(</span>Transaction<span class="op">){</span>timestamp<span class="op">,</span> t<span class="op">-&gt;</span>amount<span class="op">};</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>Transaction setAmount<span class="op">(</span><span class="dt">const</span> Transaction<span class="op">*</span> t<span class="op">,</span> <span class="dt">double</span> amount<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(</span>Transaction<span class="op">){</span>t<span class="op">-&gt;</span>timestamp<span class="op">,</span> amount<span class="op">};</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This is much simpler in languages where you can associate functions with data, like OOP and classes. For example, this is the common “value object” pattern in java (roughly related to the java bean<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Transaction <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="dt">long</span> timestamp<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="dt">double</span> amount<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">Transaction</span><span class="op">(</span><span class="dt">long</span> timestamp<span class="op">,</span> <span class="dt">double</span> amount<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">timestamp</span> <span class="op">=</span> timestamp<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">amount</span> <span class="op">=</span> amount<span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> <span class="fu">getTimestamp</span><span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> timestamp<span class="op">;</span> <span class="op">}</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">double</span> <span class="fu">getAmount</span><span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> amount<span class="op">;</span> <span class="op">}</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> Transaction <span class="fu">setTimestamp</span><span class="op">(</span><span class="dt">long</span> newTimestamp<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">Transaction</span><span class="op">(</span>newTimestamp<span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="fu">amount</span><span class="op">);</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> Transaction <span class="fu">setAmount</span><span class="op">(</span><span class="dt">double</span> newAmount<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">Transaction</span><span class="op">(</span><span class="kw">this</span><span class="op">.</span><span class="fu">timestamp</span><span class="op">,</span> newAmount<span class="op">);</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>And there you go. Nothing too surprising there!</p>
<p>In this case, not only are these ADTs (algebraic data types), they’re also ADTs (<strong>abstract</strong> data types): you are meant to work with them based on a pre-defined abstract interface based on type algebra, instead of their internal representations.</p>
<h3 id="sum-types">Sum Types</h3>
<p>If your language doesn’t support sum types, usually the way to go is with the <em>visitor pattern</em>: the underlying implementation is hidden, and the only way to process a sum type value is by providing handlers for every branch — a pattern match as a function, essentially. Your sum values then basically determine which handler is called.</p>
<p>For example, we can implement it for a network address type that can either be IPv4 or IPv6. Here we are using C++ just for generics and lambdas with closures, for simplicity, but we’ll discuss how this might look in C later.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;format&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cstdint&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> IPAddress <span class="op">{</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> isIPv4<span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint32_t</span> ipv4<span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> ipv6<span class="op">[</span><span class="dv">16</span><span class="op">];</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> R<span class="op">&gt;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> IPAddressVisitor <span class="op">{</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    R <span class="op">(*</span>visitIPv4<span class="op">)(</span><span class="dt">uint32_t</span><span class="op">);</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    R <span class="op">(*</span>visitIPv6<span class="op">)(</span><span class="at">const</span> <span class="dt">uint8_t</span> <span class="op">(&amp;)[</span><span class="dv">16</span><span class="op">]);</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> R<span class="op">&gt;</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>R acceptIPAddress<span class="op">(</span><span class="at">const</span> IPAddress<span class="op">&amp;</span> ip<span class="op">,</span> IPAddressVisitor<span class="op">&lt;</span>R<span class="op">&gt;</span> visitor<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ip<span class="op">.</span>isIPv4 <span class="op">?</span> visitor<span class="op">.</span>visitIPv4<span class="op">(</span>ip<span class="op">.</span>ipv4<span class="op">)</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>                     <span class="op">:</span> visitor<span class="op">.</span>visitIPv6<span class="op">(</span>ip<span class="op">.</span>ipv6<span class="op">);</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>You can create the values using:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>IPAddress mkIPv4<span class="op">(</span><span class="dt">uint32_t</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">{</span> <span class="kw">true</span><span class="op">,</span> <span class="op">{</span> value <span class="op">}</span> <span class="op">};</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>IPAddress mkIPv6<span class="op">(</span><span class="at">const</span> <span class="dt">uint8_t</span> <span class="op">(&amp;</span>value<span class="op">)[</span><span class="dv">16</span><span class="op">])</span> <span class="op">{</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    IPAddress out <span class="op">=</span> <span class="op">{</span> <span class="kw">false</span> <span class="op">};</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>copy<span class="op">(</span><span class="bu">std::</span>begin<span class="op">(</span>value<span class="op">),</span> <span class="bu">std::</span>end<span class="op">(</span>value<span class="op">),</span> out<span class="op">.</span>ipv6<span class="op">);</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out<span class="op">;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>And we can show an address:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>string showIPAddress<span class="op">(</span><span class="at">const</span> IPAddress<span class="op">&amp;</span> ip<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    IPAddressVisitor<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;</span> visitor <span class="op">=</span> <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">[](</span><span class="dt">uint32_t</span> v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">std::</span>format<span class="op">(</span><span class="st">&quot;</span><span class="sc">{}</span><span class="st">.</span><span class="sc">{}</span><span class="st">.</span><span class="sc">{}</span><span class="st">.</span><span class="sc">{}</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                               <span class="op">(</span>v <span class="op">&gt;&gt;</span> <span class="dv">24</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xFF</span><span class="op">,</span> <span class="op">(</span>v <span class="op">&gt;&gt;</span> <span class="dv">16</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xFF</span><span class="op">,</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                               <span class="op">(</span>v <span class="op">&gt;&gt;</span> <span class="dv">8</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xFF</span><span class="op">,</span> v <span class="op">&amp;</span> <span class="bn">0xFF</span><span class="op">);</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">},</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">[](</span><span class="at">const</span> <span class="dt">uint8_t</span> <span class="op">(&amp;</span>v<span class="op">)[</span><span class="dv">16</span><span class="op">])</span> <span class="op">{</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">std::</span>format<span class="op">(</span><span class="st">&quot;</span><span class="sc">{:02X}{:02X}</span><span class="st">:</span><span class="sc">{:02X}{:02X}</span><span class="st">:</span><span class="sc">{:02X}{:02X}</span><span class="st">:</span><span class="sc">{:02X}{:02X}</span><span class="st">:&quot;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;</span><span class="sc">{:02X}{:02X}</span><span class="st">:</span><span class="sc">{:02X}{:02X}</span><span class="st">:</span><span class="sc">{:02X}{:02X}</span><span class="st">:</span><span class="sc">{:02X}{:02X}</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>                               v<span class="op">[</span><span class="dv">0</span><span class="op">],</span> v<span class="op">[</span><span class="dv">1</span><span class="op">],</span> v<span class="op">[</span><span class="dv">2</span><span class="op">],</span> v<span class="op">[</span><span class="dv">3</span><span class="op">],</span> v<span class="op">[</span><span class="dv">4</span><span class="op">],</span> v<span class="op">[</span><span class="dv">5</span><span class="op">],</span> v<span class="op">[</span><span class="dv">6</span><span class="op">],</span> v<span class="op">[</span><span class="dv">7</span><span class="op">],</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>                               v<span class="op">[</span><span class="dv">8</span><span class="op">],</span> v<span class="op">[</span><span class="dv">9</span><span class="op">],</span> v<span class="op">[</span><span class="dv">10</span><span class="op">],</span> v<span class="op">[</span><span class="dv">11</span><span class="op">],</span> v<span class="op">[</span><span class="dv">12</span><span class="op">],</span> v<span class="op">[</span><span class="dv">13</span><span class="op">],</span> v<span class="op">[</span><span class="dv">14</span><span class="op">],</span> v<span class="op">[</span><span class="dv">15</span><span class="op">]);</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> acceptIPAddress<span class="op">(</span>ip<span class="op">,</span> visitor<span class="op">);</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Note that in this way, the compiler enforces that we handle every branch. And, if we ever add a new branch, everything that ever consumes <code>IPAddress</code> with an <code>IPAddressVisitor</code> will have to add a new handler.</p>
<p>In a language <em>without</em> generics or powerful enough polymorphism, it’s difficult to enforce the “pure” visitor pattern because you can’t ensure that all branches return the same type.</p>
<p>One common pattern is to have an “effectful” visitor pattern, where the point isn’t to <em>return</em> something, but to execute something on the payload of the present branch. This is pretty effective for languages like C, javascript, python, etc. where types aren’t really a rigid thing.</p>
<p>For example, this might be how you treat an “implicit nullable”:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> visitMaybe <span class="op">=</span> (visitNothing<span class="op">,</span> visitJust<span class="op">,</span> val) <span class="kw">=&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  (val <span class="op">==</span> <span class="kw">null</span>) <span class="op">?</span> <span class="fu">visitNothing</span>() <span class="op">:</span> <span class="fu">visitJust</span>(val)<span class="op">;</span></span></code></pre></div>
<p>This is basically <code>for_</code> from Haskell: You can do something like conditionally launch some action if the value is present.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">visitMaybe</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  () <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Nothing to request&quot;</span>)<span class="op">,</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  (reqPayload) <span class="kw">=&gt;</span> <span class="fu">makeRequest</span>(<span class="st">&quot;google.com&quot;</span><span class="op">,</span> reqPayload)<span class="op">,</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  maybeRequest</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code></pre></div>
<p>On a simpler note, if your language as subtyping built in (maybe with classes and subclasses) or some other form of dynamic dispatch, you can implement it in terms of that, which is nice in python, java, C++, etc.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> ExprVisitor<span class="op">&lt;</span>R<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    R <span class="fu">visitLit</span><span class="op">(</span><span class="dt">int</span> value<span class="op">);</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    R <span class="fu">visitNegate</span><span class="op">(</span>Expr unary<span class="op">);</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    R <span class="fu">visitAdd</span><span class="op">(</span>Expr left<span class="op">,</span> Expr right<span class="op">);</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    R <span class="fu">visitMul</span><span class="op">(</span>Expr left<span class="op">,</span> Expr right<span class="op">);</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="kw">abstract</span> <span class="kw">class</span> Expr <span class="op">{</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">abstract</span> <span class="op">&lt;</span>R<span class="op">&gt;</span> R <span class="fu">accept</span><span class="op">(</span>ExprVisitor<span class="op">&lt;</span>R<span class="op">&gt;</span> visitor<span class="op">);</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Alternatively, you’re in a language where lambdas are easy, instead of tupling up the visitor, you could just have <code>accept</code> itself take a number of arguments corresponding to each constructor:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">//</span> <span class="dt">Alternative</span> definition without an explicit <span class="dt">Visitor</span> <span class="kw">class</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>abstract <span class="kw">class</span> <span class="dt">Expr</span> {</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    public abstract <span class="op">&lt;</span><span class="dt">R</span><span class="op">&gt;</span> <span class="dt">R</span> accept(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Function</span><span class="op">&lt;</span>int,<span class="dt">R</span><span class="op">&gt;</span> visitLit,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Function</span><span class="op">&lt;</span><span class="dt">Expr</span>,<span class="dt">R</span><span class="op">&gt;</span> visitNegate,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">BiFunction</span><span class="op">&lt;</span><span class="dt">Expr</span>,<span class="dt">Expr</span>,<span class="dt">R</span><span class="op">&gt;</span> visitAdd,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">BiFunction</span><span class="op">&lt;</span><span class="dt">Expr</span>,<span class="dt">Expr</span>,<span class="dt">R</span><span class="op">&gt;</span> visitMul</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>(Note that C++ doesn’t allow template virtual methods — not because it’s not possible within the language semantics and syntax, but rather because the maintainers are too lazy to add it — so doing this faithfully requires a bit more creativity)</p>
<p>Now, if your language has dynamic dispatch or subclass polymorphism, you can actually do a different encoding, instead of the tagged union. This will work in languages that don’t allow or fully support naked union types, too. In this method, each constructor becomes a class, but it’s important to <em>only allow</em> access using <code>accept</code> to properly enforce the sum type pattern.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Lit <span class="kw">extends</span> Expr <span class="op">{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="dt">int</span> value<span class="op">;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">Lit</span><span class="op">(</span><span class="dt">int</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">value</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="op">&lt;</span>R<span class="op">&gt;</span> R <span class="fu">accept</span><span class="op">(</span>ExprVisitor<span class="op">&lt;</span>R<span class="op">&gt;</span> visitor<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> visitor<span class="op">.</span><span class="fu">visitLit</span><span class="op">(</span>value<span class="op">);</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Negate <span class="kw">extends</span> Expr <span class="op">{</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> Expr unary<span class="op">;</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">Negate</span><span class="op">(</span>Expr unary<span class="op">)</span> <span class="op">{</span> <span class="kw">this</span><span class="op">.</span><span class="fu">unary</span> <span class="op">=</span> unary<span class="op">;</span> <span class="op">}</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="op">&lt;</span>R<span class="op">&gt;</span> R <span class="fu">accept</span><span class="op">(</span>ExprVisitor<span class="op">&lt;</span>R<span class="op">&gt;</span> visitor<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> visitor<span class="op">.</span><span class="fu">visitNegate</span><span class="op">(</span>unary<span class="op">);</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Add <span class="kw">extends</span> Expr <span class="op">{</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> Expr left<span class="op">;</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> Expr right<span class="op">;</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">Add</span><span class="op">(</span>Expr left<span class="op">,</span> Expr right<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">left</span> <span class="op">=</span> left<span class="op">;</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">right</span> <span class="op">=</span> right<span class="op">;</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="op">&lt;</span>R<span class="op">&gt;</span> R <span class="fu">accept</span><span class="op">(</span>ExprVisitor<span class="op">&lt;</span>R<span class="op">&gt;</span> visitor<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> visitor<span class="op">.</span><span class="fu">visitAdd</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">);</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Mul <span class="kw">extends</span> Expr <span class="op">{</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> Expr left<span class="op">;</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> Expr right<span class="op">;</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">Mul</span><span class="op">(</span>Expr left<span class="op">,</span> Expr right<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">left</span> <span class="op">=</span> left<span class="op">;</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">right</span> <span class="op">=</span> right<span class="op">;</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="op">&lt;</span>R<span class="op">&gt;</span> R <span class="fu">accept</span><span class="op">(</span>ExprVisitor<span class="op">&lt;</span>R<span class="op">&gt;</span> visitor<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> visitor<span class="op">.</span><span class="fu">visitMul</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">);</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>(But, just wanted to note that if you actually <em>are</em> working in java, you can actually do something with sealed classes, which allows exhaustiveness checking for its native switch/case statements.)</p>
<p>Alternatively you could make all of the subclasses anonymous and expose them as factory methods, if your language allows it:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">abstract</span> <span class="kw">class</span> Expr <span class="op">{</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">abstract</span> <span class="op">&lt;</span>R<span class="op">&gt;</span> R <span class="fu">accept</span><span class="op">(</span>ExprVisitor<span class="op">&lt;</span>R<span class="op">&gt;</span> visitor<span class="op">);</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> Expr <span class="fu">lit</span><span class="op">(</span><span class="dt">int</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">Expr</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="op">&lt;</span>R<span class="op">&gt;</span> R <span class="fu">accept</span><span class="op">(</span>ExprVisitor<span class="op">&lt;</span>R<span class="op">&gt;</span> visitor<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> visitor<span class="op">.</span><span class="fu">visitLit</span><span class="op">(</span>value<span class="op">);</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> Expr <span class="fu">negate</span><span class="op">(</span>Expr unary<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">Expr</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="op">&lt;</span>R<span class="op">&gt;</span> R <span class="fu">accept</span><span class="op">(</span>ExprVisitor<span class="op">&lt;</span>R<span class="op">&gt;</span> visitor<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> visitor<span class="op">.</span><span class="fu">visitNegate</span><span class="op">(</span>unary<span class="op">);</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> Expr <span class="fu">add</span><span class="op">(</span>Expr left<span class="op">,</span> Expr right<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">Expr</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="op">&lt;</span>R<span class="op">&gt;</span> R <span class="fu">accept</span><span class="op">(</span>ExprVisitor<span class="op">&lt;</span>R<span class="op">&gt;</span> visitor<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> visitor<span class="op">.</span><span class="fu">visitAdd</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">);</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ... etc</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>You’d then call using:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Main <span class="op">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>        Expr expr <span class="op">=</span> <span class="kw">new</span> <span class="fu">Mul</span><span class="op">(</span><span class="kw">new</span> <span class="fu">Negate</span><span class="op">(</span><span class="kw">new</span> <span class="fu">Add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">Lit</span><span class="op">(</span><span class="dv">4</span><span class="op">),</span> <span class="kw">new</span> <span class="fu">Lit</span><span class="op">(</span><span class="dv">5</span><span class="op">))),</span> <span class="kw">new</span> <span class="fu">Lit</span><span class="op">(</span><span class="dv">8</span><span class="op">));</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">// or</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Expr expr = Eval.mul(Eval.negate(Eval.add(Eval.lit(4), Eval.lit(5))), Eval.lit(8));</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        ExprVisitor<span class="op">&lt;</span><span class="bu">Integer</span><span class="op">&gt;</span> eval <span class="op">=</span> <span class="kw">new</span> ExprVisitor<span class="op">&lt;&gt;()</span> <span class="op">{</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span> <span class="kw">public</span> <span class="bu">Integer</span> <span class="fu">visitLit</span><span class="op">(</span><span class="dt">int</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> value<span class="op">;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span> <span class="kw">public</span> <span class="bu">Integer</span> <span class="fu">visitNegate</span><span class="op">(</span>Expr unary<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="op">-</span>unary<span class="op">.</span><span class="fu">accept</span><span class="op">(</span><span class="kw">this</span><span class="op">);</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span> <span class="kw">public</span> <span class="bu">Integer</span> <span class="fu">visitAdd</span><span class="op">(</span>Expr left<span class="op">,</span> Expr right<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> left<span class="op">.</span><span class="fu">accept</span><span class="op">(</span><span class="kw">this</span><span class="op">)</span> <span class="op">+</span> right<span class="op">.</span><span class="fu">accept</span><span class="op">(</span><span class="kw">this</span><span class="op">);</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span> <span class="kw">public</span> <span class="bu">Integer</span> <span class="fu">visitMul</span><span class="op">(</span>Expr left<span class="op">,</span> Expr right<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> left<span class="op">.</span><span class="fu">accept</span><span class="op">(</span><span class="kw">this</span><span class="op">)</span> <span class="op">*</span> right<span class="op">.</span><span class="fu">accept</span><span class="op">(</span><span class="kw">this</span><span class="op">);</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Result: &quot;</span> <span class="op">+</span> expr<span class="op">.</span><span class="fu">accept</span><span class="op">(</span>eval<span class="op">));</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Passing around function references like this is actually pretty close to the scott encoding of our data type — and for non-recursive types, it’s essentially the church encoding.</p>
<h3 id="recursive-types">Recursive Types</h3>
<p>Speaking of recursive types…what if your language doesn’t allow recursive data types? What if it doesn’t allow recursion at all, or what if recursively generated values are just annoying to deal with? Just imagine writing that <code>Expr</code> type in a language with explicit memory management, for example. Or, what if you wanted a way to express your recursive types in a more elegant and runtime-safe manner?</p>
<p>One thing you can instead do is have your visitor be in its “catamorphism”, or church encoding. Instead of having the “visitor” take the recursive sub-values, instead have it return the result of recursively applying itself.</p>
<p>Let’s do this in <em>dhall</em>, one of the most famous non-recursive languages. Dhall <em>does</em> have native sum types, so we won’t worry about manually writing a visitor pattern. But it does <em>not</em> have recursive data types.</p>
<p>Let’s define a type like:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Expr</span> <span class="ot">=</span> <span class="dt">Lit</span> <span class="dt">Natural</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>          <span class="op">|</span> <span class="dt">Add</span> <span class="dt">Expr</span> <span class="dt">Expr</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>          <span class="op">|</span> <span class="dt">Mul</span> <span class="dt">Expr</span> <span class="dt">Expr</span></span></code></pre></div>
<p>But we can’t define data types in dhall that refer to themselves. So instead, we can define them in their “church encoding”: give what you would do with an <code>Expr</code> to consume it, where the consumption function is given as if it were recursively applied.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode dhall"><code class="sourceCode "><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span><span class="co"> </span>ExprF<span class="co"> </span>:<span class="co"> </span>Type<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Type</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">      </span>=<span class="co"> </span><span class="op">\</span>(r<span class="co"> </span>:<span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">        </span>{<span class="co"> </span>lit<span class="co"> </span>:<span class="co"> </span>Natural<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>r</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">        </span>,<span class="co"> </span>add<span class="co">    </span>:<span class="co"> </span>r<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>r<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>r</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">        </span>,<span class="co"> </span>mul<span class="co">    </span>:<span class="co"> </span>r<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>r<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>r</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">        </span>}</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span><span class="co"> </span>Expr<span class="co"> </span>:<span class="co"> </span>Type</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">      </span>=<span class="co"> </span><span class="kw">forall</span><span class="co"> </span>(r<span class="co"> </span>:<span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>ExprF<span class="co"> </span>r<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>r</span></code></pre></div>
<p>Note that <code>ExprF r</code> is essentially <code>ExprVisitor&lt;R&gt;</code>, except instead of <code>add</code> being <code>Expr -&gt; Expr -&gt; r</code>, it’s <code>r -&gt; r -&gt; r</code>: the input values aren’t the expression, but rather the results of recursively folding on the expression. In fact, our original non-recursive <code>ExprVisitor&lt;R&gt;</code> (to be more precise, the <code>R accept(ExprVisitor&lt;R&gt;)</code>) is often called the “scott encoding”, as opposed to the recursive “church encoding” fold.</p>
<p>For value creation, you <em>take</em> the visitor and recursively apply:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode dhall"><code class="sourceCode "><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span><span class="co"> </span>lit<span class="co"> </span>:<span class="co"> </span>Natural<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Expr</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">      </span>=<span class="co"> </span><span class="op">\</span>(x<span class="co"> </span>:<span class="co"> </span>Natural)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">        </span><span class="op">\</span>(r<span class="co"> </span>:<span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">        </span><span class="op">\</span>(handlers<span class="co"> </span>:<span class="co"> </span>ExprF<span class="co"> </span>r)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">            </span>handlers.lit<span class="co"> </span>x</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span><span class="co"> </span>add<span class="co"> </span>:<span class="co"> </span>Expr<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Expr<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Expr</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">      </span>=<span class="co"> </span><span class="op">\</span>(left<span class="co"> </span>:<span class="co"> </span>Expr)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">        </span><span class="op">\</span>(right<span class="co"> </span>:<span class="co"> </span>Expr)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">        </span><span class="op">\</span>(r<span class="co"> </span>:<span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co">        </span><span class="op">\</span>(handlers<span class="co"> </span>:<span class="co"> </span>ExprF<span class="co"> </span>r)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co">            </span>handlers.add<span class="co"> </span>(left<span class="co"> </span>r<span class="co"> </span>handlers)<span class="co"> </span>(right<span class="co"> </span>r<span class="co"> </span>handlers)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span><span class="co"> </span>mul<span class="co"> </span>:<span class="co"> </span>Expr<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Expr<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Expr</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">      </span>=<span class="co"> </span><span class="op">\</span>(left<span class="co"> </span>:<span class="co"> </span>Expr)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co">        </span><span class="op">\</span>(right<span class="co"> </span>:<span class="co"> </span>Expr)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co">        </span><span class="op">\</span>(r<span class="co"> </span>:<span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co">        </span><span class="op">\</span>(handlers<span class="co"> </span>:<span class="co"> </span>ExprF<span class="co"> </span>r)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co">            </span>handlers.mul<span class="co"> </span>(left<span class="co"> </span>r<span class="co"> </span>handlers)<span class="co"> </span>(right<span class="co"> </span>r<span class="co"> </span>handlers)</span></code></pre></div>
<p>And finally, <em>using</em> the data type involves providing the <code>handler</code> to fold up from the bottom to top. Note that <code>add : \(left : Natural) -&gt; \(right : Natural) -&gt; left + right</code> already assumes that the handler has been applied to the sub-expressions, so you get <code>Natural</code>s on both sides instead of <code>Expr</code>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode dhall"><code class="sourceCode "><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span><span class="co"> </span>eval<span class="co"> </span>:<span class="co"> </span>Expr<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Natural</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">      </span>=<span class="co"> </span><span class="op">\</span>(e<span class="co"> </span>:<span class="co"> </span>Expr)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">          </span>e<span class="co"> </span>Natural</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">            </span>{<span class="co"> </span>lit<span class="co"> </span>=<span class="co"> </span><span class="op">\</span>(x<span class="co"> </span>:<span class="co"> </span>Natural)<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>x</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">            </span>,<span class="co"> </span>add<span class="co"> </span>=<span class="co"> </span><span class="op">\</span>(left<span class="co"> </span>:<span class="co"> </span>Natural)<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span><span class="op">\</span>(right<span class="co"> </span>:<span class="co"> </span>Natural)<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>left<span class="co"> </span>+<span class="co"> </span>right</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">            </span>,<span class="co"> </span>mul<span class="co"> </span>=<span class="co"> </span><span class="op">\</span>(left<span class="co"> </span>:<span class="co"> </span>Natural)<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span><span class="op">\</span>(right<span class="co"> </span>:<span class="co"> </span>Natural)<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>left<span class="co"> </span>*<span class="co"> </span>right</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">            </span>}</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span><span class="co"> </span>testVal<span class="co"> </span>:<span class="co"> </span>Expr</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">      </span>=<span class="co"> </span>mul<span class="co"> </span>(add<span class="co"> </span>(lit<span class="co"> </span><span class="dv">4</span>)<span class="co"> </span>(lit<span class="co"> </span><span class="dv">5</span>))<span class="co"> </span>(lit<span class="co"> </span><span class="dv">8</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span><span class="co">  </span><span class="kw">assert</span><span class="co"> </span>:<span class="co"> </span>eval<span class="co"> </span>testVal<span class="co"> </span><span class="op">===</span><span class="co"> </span><span class="dv">72</span></span></code></pre></div>
<p>This pattern is useful even in languages with good datatype recursion, like Haskell — it’s actually the <a href="https://hackage.haskell.org/package/recursion-schemes">recursion-schemes</a> refactoring of a recursive data type, and it can be useful to have it live alongside your normal recursive types. I’ve written <a href="https://blog.jle.im/entry/tries-with-recursion-schemes.html">this blog post</a> talking about how useful this pattern is to have alongside your normal recursive types.</p>
<p>This pattern is pretty portable to other languages too, as long as you can scrounge together something like Rank-N types:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> ExprFold<span class="op">&lt;</span>R<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    R <span class="fu">foldLit</span><span class="op">(</span><span class="dt">int</span> value<span class="op">);</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    R <span class="fu">foldNegate</span><span class="op">(</span>R unary<span class="op">);</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    R <span class="fu">foldAdd</span><span class="op">(</span>R left<span class="op">,</span> R right<span class="op">);</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    R <span class="fu">foldMul</span><span class="op">(</span>R left<span class="op">,</span> R right<span class="op">);</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> Expr <span class="op">{</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">abstract</span> <span class="op">&lt;</span>R<span class="op">&gt;</span> R <span class="fu">accept</span><span class="op">(</span>ExprFold<span class="op">&lt;</span>R<span class="op">&gt;</span> fold<span class="op">);</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> Expr <span class="fu">lit</span><span class="op">(</span><span class="dt">int</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">Expr</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="op">&lt;</span>R<span class="op">&gt;</span> R <span class="fu">accept</span><span class="op">(</span>ExprFold<span class="op">&lt;</span>R<span class="op">&gt;</span> fold<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> fold<span class="op">.</span><span class="fu">foldLit</span><span class="op">(</span>value<span class="op">);</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> Expr <span class="fu">negate</span><span class="op">(</span>Expr unary<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">Expr</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="op">&lt;</span>R<span class="op">&gt;</span> R <span class="fu">accept</span><span class="op">(</span>ExprFold<span class="op">&lt;</span>R<span class="op">&gt;</span> fold<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> fold<span class="op">.</span><span class="fu">foldNegate</span><span class="op">(</span>unary<span class="op">.</span><span class="fu">accept</span><span class="op">(</span>fold<span class="op">));</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// etc.</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>By “Rank-N types” here, I mean that your objects can generate polymorphic functions: given an <code>Expr</code>, you could <em>generate</em> an <code>&lt;R&gt; R accept(ExprFold &lt;R&gt; fold)</code> for any <code>R</code>, and not something pre-determined or pre-chosen by your choice of representation of <code>Expr</code>.</p>
<h2 id="generalized-algebraic-data-types">Generalized Algebraic Data Types</h2>
<p>You’ve implemented ADTs in your language of choice, or you are currently in a language with native ADTs. Life is good, right? Until that sneaky voice starts whispering in your hear: “we need more type safety.” You resist that urge, maybe even get a lot done without it, but eventually you are compelled to give in and embrace the warm yet harsh embrace of ultimate type safety. Now what?</p>
<h3 id="singletons-and-witnesses">Singletons and Witnesses</h3>
<p>In Haskell, singletons are essentially enums used to associate a value with a reifiable type. “Reifiable” here means that you can take the runtime value of a singleton and use it to bring evidence to the type-level. I ran into a real-world usage of this while writing <a href="https://coronavirus.jle.im/" class="uri">https://coronavirus.jle.im/</a>, a web-based data visualizer of COVID-19 data (<a href="https://github.com/mstksg/corona-charts/tree/master">source here</a>) in purescript. I needed a singleton to represent <em>scales</em> for scatter plots and linking them to the data that can be plotted. And, not only did it need to be type-safe in purescript (which has ADTs but not GADTs), it had to be type-safe in the javascript ffi as well.</p>
<p>Here’s how it might look in Haskell:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Numeric types</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">NType</span><span class="ot"> ::</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NInt</span><span class="ot"> ::</span> <span class="dt">NType</span> <span class="dt">Int</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NDouble</span><span class="ot"> ::</span> <span class="dt">NType</span> <span class="dt">Double</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NPercent</span><span class="ot"> ::</span> <span class="dt">NType</span> <span class="dt">Percent</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Define a scale</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Scale</span><span class="ot"> ::</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ScaleDate</span><span class="ot"> ::</span> <span class="dt">Scale</span> <span class="dt">Date</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ScaleLinear</span><span class="ot"> ::</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">NType</span> a <span class="ot">-&gt;</span> <span class="dt">Scale</span> a   <span class="co">-- ^ whether to include zero in the axis or not</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ScaleLog</span><span class="ot"> ::</span> <span class="dt">NType</span> a <span class="ot">-&gt;</span> <span class="dt">Scale</span> a</span></code></pre></div>
<p>You’d then run it like this:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ot">plot ::</span> <span class="dt">Scale</span> a <span class="ot">-&gt;</span> <span class="dt">Scale</span> b <span class="ot">-&gt;</span> [(a, b)] <span class="ot">-&gt;</span> <span class="dt">Canvas</span></span></code></pre></div>
<p>So, we have the <em>type</em> of the input tuples being determined by the <em>values</em> you pass to <code>plot</code>:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="op">:</span>t plot <span class="dt">ScaleDate</span> (<span class="dt">ScaleLinear</span> <span class="dt">True</span> (<span class="dt">LNumeric</span> <span class="dt">NInt</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>[(<span class="dt">Date</span>, <span class="dt">Int</span>)] <span class="ot">-&gt;</span> <span class="dt">Canvas</span></span></code></pre></div>
<p>But let’s say we only had ADTs. And then we’re passing them down to a javascript FFI which only has structs and functions. We could drop the type-safety and instead error on runtime, but…no. Type unsafety is not acceptable.</p>
<p>The fundamental ability we want to gain is that if we pattern match on <code>ScaleDate</code>, then we <em>know</em> <code>a</code> has to be <code>Date</code>. If we match on <code>NInt</code>, we know that <code>a</code> <em>has</em> to be <code>Int</code>.</p>
<p>For the sake of this example, we’re going to be implementing a simpler function in purescript and in javascript: a function that takes a scale type and a list of points prints the bounds. In Haskell, this looks like:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">AxisBounds</span> a <span class="ot">=</span> <span class="dt">AB</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> minValue ::</span> a</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> minLabel ::</span> <span class="dt">String</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> maxValue ::</span> a</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> maxLabel ::</span> <span class="dt">String</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="ot">displayAxis ::</span> <span class="dt">Scale</span> a <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">AxisBounds</span> a</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>displayAxis <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ScaleDate</span> <span class="ot">-&gt;</span> \xs <span class="ot">-&gt;</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> xMin <span class="ot">=</span> <span class="fu">minimum</span> xs</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>          xMax <span class="ot">=</span> <span class="fu">maximum</span> xs</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>       <span class="kw">in</span> <span class="dt">AB</span> xMin (showDate xMin) xMax (showDate xMax)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ScaleLinear</span> hasZero nt <span class="ot">-&gt;</span> \xs <span class="ot">-&gt;</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>      displayNumericAxis (<span class="kw">if</span> hasZero <span class="kw">then</span> <span class="dv">0</span><span class="op">:</span>xs <span class="kw">else</span> xs)</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ScaleLog</span> nt <span class="ot">-&gt;</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>      displayNumericAxis nt xs</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="ot">displayNumericAxis ::</span> <span class="dt">NType</span> a <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">AxisBounds</span> a</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>displayNumericAxis <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NInt</span> <span class="ot">-&gt;</span> \xs <span class="ot">-&gt;</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> xMin <span class="ot">=</span> <span class="fu">minimum</span> xs</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>          xMax <span class="ot">=</span> <span class="fu">maximum</span> xs</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>       <span class="kw">in</span> <span class="dt">AB</span> xMin (printf <span class="st">&quot;%d&quot;</span> xMin) xMax (printf <span class="st">&quot;%d&quot;</span> xMax)</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NDouble</span> <span class="ot">-&gt;</span> \xs <span class="ot">-&gt;</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> xMin <span class="ot">=</span> <span class="fu">minimum</span> xs</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>          xMax <span class="ot">=</span> <span class="fu">maximum</span> xs</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>       <span class="kw">in</span> <span class="dt">AB</span> xMin (printf <span class="st">&quot;%.4f&quot;</span> xMin) xMax (printf <span class="st">&quot;%.4f&quot;</span> xMax)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NPercent</span> <span class="ot">-&gt;</span> \xs <span class="ot">-&gt;</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> xMin <span class="ot">=</span> <span class="fu">minimum</span> xs</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>          xMax <span class="ot">=</span> <span class="fu">maximum</span> xs</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>       <span class="kw">in</span> <span class="dt">AB</span> xMin (printf <span class="st">&quot;%.1f%%&quot;</span> (xMin<span class="op">*</span><span class="dv">100</span>)) xMax (printf <span class="st">&quot;%.1f%%&quot;</span> (xMax<span class="op">*</span><span class="dv">100</span>))</span></code></pre></div>
<p>(Pretend the <code>Percent</code> type is just a newtype-wrapped <code>Float</code> or something)</p>
<p>There are at least two main approaches to do this. We’ll be discussing runtime equality witnesses and Higher-Kinded Eliminators.</p>
<h4 id="runtime-witnesses-and-coyoneda-embedding">Runtime Witnesses and Coyoneda Embedding</h4>
<p>The <a href="https://ncatlab.org/nlab/show/Yoneda+embedding">Yoneda Lemma</a> is one of the most powerful tools that Category Theory has yielded as a branch of math, but its sibling <a href="https://hackage.haskell.org/package/kan-extensions/docs/Data-Functor-Coyoneda.html">coyoneda</a> is one of the most useful Haskell abstractions.</p>
<p>This doesn’t give you GADTs, but it’s a very lightweight way to “downgrade” your GADTs into normal GADTs which is appropriate if you don’t need the full power.</p>
<p>The trick is this: if you have <code>MyGADT a</code>, and you know you are going to be using it to <em>produce</em> <code>a</code>s, you can do a covariant coyoneda transform.</p>
<p>For example, if you have this type representing potential data sources:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Source</span><span class="ot"> ::</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ByteSource</span><span class="ot"> ::</span> <span class="dt">Handle</span> <span class="ot">-&gt;</span> <span class="dt">Source</span> <span class="dt">Word</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">StringSource</span><span class="ot"> ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Source</span> <span class="dt">String</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="ot">readByte ::</span> <span class="dt">Handle</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Word</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="ot">readString ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">String</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="ot">readSource ::</span> <span class="dt">Source</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> a</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>readSource <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ByteSource</span> h <span class="ot">-&gt;</span> readByte h</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">StringSource</span> fp <span class="ot">-&gt;</span> readString fp</span></code></pre></div>
<p>You could instead turn <code>Source</code> into a non-GADT by making it a normal parameterized ADT and adding a <code>X -&gt; a</code> field, which is a type of CPS transformation:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Source</span> a <span class="ot">=</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ByteSource</span> <span class="dt">Handle</span> (<span class="dt">Word</span> <span class="ot">-&gt;</span> a)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">StringSource</span> <span class="dt">FilePath</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> a)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="ot">byteSource ::</span> <span class="dt">Handle</span> <span class="ot">-&gt;</span> <span class="dt">Source</span> <span class="dt">Word</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>byteSource h <span class="ot">=</span> <span class="dt">ByteSource</span> h <span class="fu">id</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="ot">stringSource ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Source</span> <span class="dt">String</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>stringSource fp <span class="ot">=</span> <span class="dt">StringSource</span> fp <span class="fu">id</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="ot">readSource ::</span> <span class="dt">Source</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> a</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>readSource <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ByteSource</span> h out <span class="ot">-&gt;</span> out <span class="op">&lt;$&gt;</span> readByte h</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">StringSource</span> fp out <span class="ot">-&gt;</span> out <span class="op">&lt;$&gt;</span> readString fp</span></code></pre></div>
<p>A nice benefit of this method is that <code>Source</code> can now have a <code>Functor</code> instance, which the original GADT could not.</p>
<p>And, if <code>MyGADT a</code> is going to be <em>consuming</em> <code>a</code>s, you can do the <a href="https://hackage.haskell.org/package/kan-extensions/docs/Data-Functor-Contravariant-Coyoneda.html">contravariant coyoneda</a> transform:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Sink</span> a <span class="ot">=</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ByteSink</span> <span class="dt">Handle</span> (a <span class="ot">-&gt;</span> <span class="dt">Word</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">StringSink</span> <span class="dt">FilePath</span> (a <span class="ot">-&gt;</span> <span class="dt">String</span>)</span></code></pre></div>
<p>This gives it a free <a href="https://hackage.haskell.org/package/base/docs/Data-Functor-Contravariant.html">Contravariant</a> instance too!</p>
<p>And, if you are going to be both consuming and producing <code>a</code>s, you can do the <em>invariant coyoneda</em> transform</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Interface</span> a <span class="ot">=</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ByteInterface</span> <span class="dt">Handle</span> (<span class="dt">Word</span> <span class="ot">-&gt;</span> a) (a <span class="ot">-&gt;</span> <span class="dt">Word</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">StringInterface</span> <span class="dt">FilePath</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> a) (<span class="dt">Word</span> <span class="ot">-&gt;</span> a)</span></code></pre></div>
<p>However, in practice, <em>true equality</em> involves being able to lift under injective type constructors, and carrying <em>every single</em> continuation is unwieldy. We can package them up together with a <strong>runtime equality witness</strong>.</p>
<p>This is something we can put “inside” <code>NInt</code> such that, when we pattern match on a <code>NType a</code>, the type system can be assured that <code>a</code> is an <code>Int</code>.</p>
<p>You need some sort of data of type <code>IsEq a b</code> with functions:</p>
<ul>
<li><code>refl :: IsEq a a</code></li>
<li><code>to :: IsEq a b -&gt; a -&gt; b</code></li>
<li><code>sym :: IsEq a b -&gt; IsEq b a</code></li>
<li><code>trans :: IsEq a b -&gt; IsEq b c -&gt; IsEq a c</code></li>
<li><code>inj :: IsEq (f a) (f b) -&gt; IsEq a b</code></li>
</ul>
<p>If you have <code>to</code> and <code>sym</code> you also get <code>from :: IsEq a b -&gt; b -&gt; a</code>.</p>
<p>From all of this, we can recover our original <code>IsEq a Word -&gt; Word -&gt; a</code> and <code>IsEq a Word -&gt; a -&gt; Word</code> functions, saving us from having to put two functions.</p>
<p>Your language of choice might already have this <code>IsEq</code>. But one of the more interesting ways to me is Leibniz equality (discussed a lot in <a href="https://ryanglscott.github.io/2021/08/22/leibniz-equality-in-haskell-part-1/">this Ryan Scott post</a>), which works in languages with higher-kinded polymorphism. Leibniz quality in languages with higher-kinded polymorphism means that <code>a</code> and <code>b</code> are equal if <code>forall p. p a -&gt; p b</code>: any property of <code>a</code> is also true of <code>b</code>.</p>
<p>In Haskell, we write this like:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Leibniz</span> a b <span class="ot">=</span> <span class="dt">Leibniz</span> (<span class="kw">forall</span> p<span class="op">.</span> p a <span class="ot">-&gt;</span> p b)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="ot">refl ::</span> <span class="dt">Leibniz</span> a a</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>refl <span class="ot">=</span> <span class="dt">Leibniz</span> <span class="fu">id</span></span></code></pre></div>
<p>The only possible way to construct a ‘Leibniz’ is with both type parameters being the same: You can only ever <em>create</em> a value of type <code>Leibniz a a</code>, never a value of <code>Leibniz a b</code> where <code>b</code> is not <code>a</code>.</p>
<p>You can prove that this is actually equality by writing functions <code>Leibniz a b -&gt; Leibniz b a</code> and <code>Leibniz a b -&gt; Leibniz b c -&gt; Leibniz a c</code> (<a href="https://ryanglscott.github.io/2021/08/22/leibniz-equality-in-haskell-part-1/">this Ryan Scott post</a> goes over it well), but in practice we realize this equality by safely coercing <code>a</code> and <code>b</code> back and forth:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Identity</span> a <span class="ot">=</span> <span class="dt">Identity</span> {<span class="ot"> runIdentity ::</span> a }</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="ot">to ::</span> <span class="dt">Leibniz</span> a b <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> b</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>to (<span class="dt">Leibniz</span> f) <span class="ot">=</span> runIdentity <span class="op">.</span> f <span class="op">.</span> <span class="dt">Identity</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Op</span> a b <span class="ot">=</span> <span class="dt">Op</span> {<span class="ot"> getOp ::</span> b <span class="ot">-&gt;</span> a }</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="ot">from ::</span> <span class="dt">Leibniz</span> a b <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> a</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>from (<span class="dt">Leibniz</span> f) <span class="ot">=</span> getOp (f (<span class="dt">Op</span> <span class="fu">id</span>))</span></code></pre></div>
<p>So, if your language supports higher-kinded Rank-2 types, you have a solution!</p>
<p>There are other solutions in other languages, but they will usually all be language-dependent.</p>
<p>Let’s write everything in purescript. The key difference is we use <code>map (to isNumber) :: Array a -&gt; Array Number</code>, etc., to get our <code>Array</code> as something we know it has the type of.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode purescript"><code class="sourceCode purescript"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Text.Printf</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Leibniz</span> a b <span class="ot">=</span> <span class="dt">Leibniz</span> (<span class="kw">forall</span> p<span class="op">.</span> p a <span class="ot">-&gt;</span> p b)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="ot">to ::</span> <span class="dt">Leibniz</span> a b <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> b</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="ot">from ::</span> <span class="dt">Leibniz</span> a b <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> a</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">NType</span> a <span class="ot">=</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NInt</span> (<span class="dt">Leibniz</span> a <span class="dt">Int</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">NNumber</span> (<span class="dt">Leibniz</span> a <span class="dt">Number</span>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">NPercent</span> (<span class="dt">Leibniz</span> a <span class="dt">Percent</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">AxisBounds</span> a <span class="ot">=</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> minValue ::</span> a</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> minLabel ::</span> <span class="dt">String</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> maxValue ::</span> a</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> maxLabel ::</span> <span class="dt">String</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="ot">displayNumericAxis ::</span> <span class="dt">NType</span> a <span class="ot">-&gt;</span> <span class="dt">Array</span> a <span class="ot">-&gt;</span> <span class="dt">AxisBounds</span> a</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>displayNumericAxis <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NInt</span> isInt <span class="ot">-&gt;</span> \xs <span class="ot">-&gt;</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> xMin <span class="ot">=</span> <span class="fu">minimum</span> <span class="op">$</span> <span class="fu">map</span> (to isInt) xs</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>          xMax <span class="ot">=</span> <span class="fu">maximum</span> <span class="op">$</span> <span class="fu">map</span> (to isInt) xs</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>          <span class="fu">showInt</span> <span class="ot">=</span> <span class="fu">show</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>       <span class="kw">in</span> { minValue<span class="op">:</span> xMin</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>          , minLabel<span class="op">:</span> <span class="fu">showInt</span> xMin</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>          , maxValue<span class="op">:</span> xMax</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>          , maxLabel<span class="op">:</span> <span class="fu">showInt</span> xMax</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NNumber</span> isNumber <span class="ot">-&gt;</span> \xs <span class="ot">-&gt;</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> xMin <span class="ot">=</span> <span class="fu">minimum</span> <span class="op">$</span> <span class="fu">map</span> (to isNumber) xs</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>          xMax <span class="ot">=</span> <span class="fu">maximum</span> <span class="op">$</span> <span class="fu">map</span> (to isNumber) xs</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>          showFloat <span class="ot">=</span> printf (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> <span class="st">&quot;%.4f&quot;</span>)   <span class="co">-- it works a little differently</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>       <span class="kw">in</span> { minValue<span class="op">:</span> xMin</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>          , minLabel<span class="op">:</span> showFloat xMin</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>          , maxValue<span class="op">:</span> xMax</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>          , maxLabel<span class="op">:</span> showFloat xMax</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NPercent</span> isPercent <span class="ot">-&gt;</span> \xs <span class="ot">-&gt;</span></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> xMin <span class="ot">=</span> <span class="fu">minimum</span> <span class="op">$</span> <span class="fu">map</span> (to isPercent) xs</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>          xMax <span class="ot">=</span> <span class="fu">maximum</span> <span class="op">$</span> <span class="fu">map</span> (to isPercent) xs</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>          showPercent <span class="ot">=</span> printf (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> <span class="st">&quot;%.1f%%&quot;</span>) <span class="op">&lt;&lt;&lt;</span> (_ <span class="op">*</span> <span class="fl">100.0</span>)</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>       <span class="kw">in</span> { minValue<span class="op">:</span> xMin</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>          , minLabel<span class="op">:</span> showPercent xMin</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>          , maxValue<span class="op">:</span> xMax</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>          , maxLabel<span class="op">:</span> showPercent xMax</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>          }</span></code></pre></div>
<p>To work with our <code>[a]</code> as if it were <code>[Int]</code>, we have to map the coercion function over it that our <code>Leibniz a Int</code> gave us. Admittedly, this naive way adds a runtime cost of copying the array. But we could be more creative with finding the minimum and maximum in this way in constant space and no extra allocations.</p>
<p>And, if we wanted to outsource this to the javascript FFI, remember that javascript doesn’t quite have sum types, so we can create a quick visitor:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode purescript"><code class="sourceCode purescript"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">NVisitor</span> a r <span class="ot">=</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> nvInt ::</span> <span class="dt">Leibniz</span> a <span class="dt">Int</span> <span class="ot">-&gt;</span> r</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> nvNumber ::</span> <span class="dt">Leibniz</span> a <span class="dt">Number</span> <span class="ot">-&gt;</span> r</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> nvPercent ::</span> <span class="dt">Leibniz</span> a <span class="dt">Percent</span> <span class="ot">-&gt;</span> r</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">NAccept</span> a <span class="ot">=</span> <span class="kw">forall</span> r<span class="op">.</span> <span class="dt">NVisitor</span> a r <span class="ot">-&gt;</span> r</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="ot">toAccept ::</span> <span class="dt">NType</span> a <span class="ot">-&gt;</span> <span class="dt">NAccept</span> a</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>toAccept <span class="ot">=</span> <span class="kw">case</span> _ <span class="kw">of</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NInt</span> isInt <span class="ot">-&gt;</span> \nv <span class="ot">-&gt;</span> nv<span class="op">.</span>nvInt isInt</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NNumber</span> isNumber <span class="ot">-&gt;</span> \nv <span class="ot">-&gt;</span> nv<span class="op">.</span>nvNumber isNumber</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NPercent</span> isPercent <span class="ot">-&gt;</span> \nv <span class="ot">-&gt;</span> nv<span class="op">.</span>nvPercent isPercent</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>foreign <span class="kw">import</span> _formatNumeric :: forall a. <span class="dt">Fn2</span> (<span class="dt">NAccept</span> a) a <span class="dt">String</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="ot">formatNumeric ::</span> <span class="dt">NType</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>formatNumeric nt <span class="ot">=</span> runFn2 _formatNumeric (toAccept nt)</span></code></pre></div>
<p>The FFI binding looks like: (taken from <a href="https://github.com/mstksg/corona-charts/blob/master/src/D3/Scatter/Type.js">my actual source code</a>)</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> d3 <span class="im">from</span> <span class="st">&quot;d3-format&quot;</span><span class="op">;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> _formatNumeric <span class="op">=</span> (naccept<span class="op">,</span> xs) <span class="kw">=&gt;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">naccept</span>(</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">nvInt</span><span class="op">:</span> (isInt) <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">format</span>(<span class="st">&quot;~s&quot;</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">,</span> <span class="dt">nvNumber</span><span class="op">:</span> (isNumber) <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">format</span>(<span class="st">&quot;.3~s&quot;</span>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">,</span> <span class="dt">nvPercent</span><span class="op">:</span> (isPercent) <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">format</span>(<span class="st">&quot;+.3~p&quot;</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span></code></pre></div>
<p>Admittedly in the javascript we are throwing away the “GADT type safety” because we throw away the equality. But we take what we can — we at least retain the visitor pattern for sum-type type safety and exhaustiveness checking. I haven’t done this in typescript yet so there might be a way to formalize Leibniz equality to do this in typescript and keep the whole chain type-safe from top to bottom.</p>
<h4 id="higher-kinded-eliminators">Higher-Kinded Eliminators</h4>
<p>This is essentially the higher-kinded version of the visitor pattern, except in dependent type theory these visitors are more often called “eliminators” or destructors, which is definitely a cooler name.</p>
<p>In the normal visitor you’d have:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">User</span> <span class="ot">=</span> <span class="dt">TheAdmin</span> <span class="op">|</span> <span class="dt">Member</span> <span class="dt">Int</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">UserHandler</span> r <span class="ot">=</span> <span class="dt">UH</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> uhTheAdmin ::</span> r</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> uhMember ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> r</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div>
<p>But note that if you have the right set of continuations, you have something that is essentially equal to <code>User</code> without having to actually use <code>User</code>:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">User&#39;</span> <span class="ot">=</span> <span class="kw">forall</span> r<span class="op">.</span> <span class="dt">UserHandler</span> r <span class="ot">-&gt;</span> r</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="ot">fromUser ::</span> <span class="dt">User</span> <span class="ot">-&gt;</span> <span class="dt">User&#39;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>fromUser <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">TheAdmin</span> <span class="ot">-&gt;</span> \<span class="dt">UH</span>{<span class="op">..</span>} <span class="ot">-&gt;</span> uhTheAdmin</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> userId <span class="ot">-&gt;</span> \<span class="dt">UH</span>{<span class="op">..</span>} <span class="ot">-&gt;</span> uhMember userId</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="ot">toUser ::</span> <span class="dt">User&#39;</span> <span class="ot">-&gt;</span> <span class="dt">Foo</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>toUser f <span class="ot">=</span> f <span class="op">$</span> <span class="dt">UH</span> { fhTheAdmin <span class="ot">=</span> <span class="dt">TheAdmin</span>, fhMember <span class="ot">=</span> <span class="dt">Member</span> }</span></code></pre></div>
<p>This means that <code>User</code> is actually equivalent to <code>forall r. UserHandler r -&gt; r</code>: they’re the same type, so if your language doesn’t have sum types, you could encode it as <code>forall r. UserHandler r -&gt; r</code> instead. Visitors, baby.</p>
<p>But, then, what actually does the <code>r</code> type variable represent here, semantically? Well, in a <code>UserHandler r</code>, <code>r</code> is the “target” that we interpret into. But there’s a deeper relationship between <code>r</code> and <code>User</code>: A <code>UserHandler r</code> essentially “embeds” a <code>User</code> into an <code>r</code>. And, a <code>UserHandler r -&gt; r</code> is the application of that embedding to an actual <code>User</code>.</p>
<p>If we pick <code>r ~ ()</code>, then <code>UserHandler ()</code> embeds <code>User</code> into <code>()</code>. If we pick <code>r ~ String</code>, then <code>UserHandler ()</code> embeds <code>User</code> into <code>String</code> (like, “showing” it). And if we pick <code>r ~ User</code>, a <code>UserHandler User</code> embeds a <code>User</code> into…itself?</p>
<p>So here, <code>r</code> is essentially the projection that we view the user through. And by making sure we are <code>forall r. UserHandler r -&gt; r</code> for <em>all</em> <code>r</code>, we ensure that we do not lose any information: the embedding is completely 1-to-1. It lets you “create” the <code>User</code> faithfully in a “polymorphic” way.</p>
<p>In fact, to hammer this home, some people like to use the name of the type as the type variable: <code>UserHandler user</code>:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- | The same thing as before but with things renamed to prove a point</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">MakeUser</span> user <span class="ot">=</span> <span class="dt">MakeUser</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> uhTheAdmin ::</span> user</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> uhMember ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> user</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">User&#39;</span> <span class="ot">=</span> <span class="kw">forall</span> user<span class="op">.</span> <span class="dt">MakeUser</span> user <span class="ot">-&gt;</span> user</span></code></pre></div>
<p>The <code>forall user.</code> lets us faithfully “create” a <code>User</code> within the system we have, without actually having a <code>User</code> data type. Essentially we can imagine the <code>r</code> in the <code>forall r</code> as “standing in” for <code>User</code>, even if that type doesn’t actually exist.</p>
<p>Now, here’s the breakthrough: If we can use <code>forall (r :: Type)</code> to substitute for <code>User :: Type</code>, how about we use a <code>forall (p :: Type -&gt; Type)</code> to substitute for a <code>Scale :: Type -&gt; Type</code>?</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Scale</span><span class="ot"> ::</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ScaleDate</span><span class="ot"> ::</span> <span class="dt">Scale</span> <span class="dt">Date</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ScaleLinear</span><span class="ot"> ::</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">LType</span> a <span class="ot">-&gt;</span> <span class="dt">Scale</span> a</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ScaleLog</span><span class="ot"> ::</span> <span class="dt">NType</span> a <span class="ot">-&gt;</span> <span class="dt">Scale</span> a</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">ScaleHandler</span> p a <span class="ot">=</span> <span class="dt">SH</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> shDate ::</span> p <span class="dt">Date</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> shLinear ::</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">NType</span> a <span class="ot">-&gt;</span> p a</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> shLog ::</span> <span class="dt">NType</span> a <span class="ot">-&gt;</span> p a</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Scale&#39;</span> a <span class="ot">=</span> <span class="kw">forall</span> p<span class="op">.</span> <span class="dt">ScaleHandler</span> p a <span class="ot">-&gt;</span> p a</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="ot">fromScale ::</span> <span class="dt">Scale</span> a <span class="ot">-&gt;</span> <span class="dt">Scale&#39;</span> a</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>fromScale <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ScaleDate</span> <span class="ot">-&gt;</span> \<span class="dt">SH</span>{<span class="op">..</span>} <span class="ot">-&gt;</span> shDate</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ScaleLinear</span> hasZero lt <span class="ot">-&gt;</span> \<span class="dt">SH</span>{<span class="op">..</span>} <span class="ot">-&gt;</span> shLinear hasZero lt</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ScaleLog</span> nt <span class="ot">-&gt;</span> \<span class="dt">SH</span>{<span class="op">..</span>} <span class="ot">-&gt;</span> shLog nt</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a><span class="ot">toScale ::</span> <span class="dt">Scale&#39;</span> a <span class="ot">-&gt;</span> <span class="dt">Scale</span> a</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>toScale f <span class="ot">=</span> f <span class="op">$</span> <span class="dt">SH</span> { shDate <span class="ot">=</span> <span class="dt">ScaleDate</span>, shLinear <span class="ot">=</span> <span class="dt">ScaleLinear</span>, shLog <span class="ot">=</span> <span class="dt">ScaleLog</span> }</span></code></pre></div>
<p>So in our new system, <code>forall p. ScaleHandler p a -&gt; p a</code> is identical to <code>Scale</code>: we can use <code>p a</code> to substitute in <code>Scale</code> in our language even if our language itself cannot support GADTs.</p>
<p>So let’s write <code>formatNType</code> in purescript. We no longer have an actual <code>Scale</code> sum type, but its higher-kinded church encoding:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode purescript"><code class="sourceCode purescript"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">NType</span> a <span class="ot">=</span> <span class="kw">forall</span> p<span class="op">.</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> int ::</span> p <span class="dt">Int</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> number ::</span> p <span class="dt">Number</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> percent ::</span> p <span class="dt">Percent</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    } <span class="ot">-&gt;</span> p a</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Scale</span> a <span class="ot">=</span> <span class="kw">forall</span> p<span class="op">.</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> date ::</span> p <span class="dt">Date</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> linear ::</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">NType</span> a <span class="ot">-&gt;</span> p a</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> log ::</span> <span class="dt">NType</span> a <span class="ot">-&gt;</span> p a</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    } <span class="ot">-&gt;</span> p a</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="ot">ntInt ::</span> <span class="dt">NType</span> <span class="dt">Int</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>ntInt nth <span class="ot">=</span> nth<span class="op">.</span>int</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="ot">ntNumber ::</span> <span class="dt">NType</span> <span class="dt">Number</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>ntNumber nth <span class="ot">=</span> nth<span class="op">.</span>number</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a><span class="ot">ntPercent ::</span> <span class="dt">NType</span> <span class="dt">Percent</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>ntPercent nth <span class="ot">=</span> nth<span class="op">.</span>percent</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a><span class="ot">formatNType ::</span> <span class="dt">NType</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>formatNType nt <span class="ot">=</span> f</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Op</span> f <span class="ot">=</span> nt</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>      { int<span class="op">:</span> <span class="dt">Op</span> <span class="fu">show</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>      , number<span class="op">:</span> <span class="dt">Op</span> <span class="op">$</span> printf (<span class="dt">Proxy</span> <span class="st">&quot;%.4f&quot;</span>)</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>      , percent<span class="op">:</span> <span class="dt">Op</span> <span class="op">$</span> printf (<span class="dt">Proxy</span> <span class="st">&quot;%.1f%%&quot;</span>) <span class="op">&lt;&lt;&lt;</span> (_ <span class="op">*</span> <span class="fl">100.0</span>)</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>      }</span></code></pre></div>
<p>Here we are using</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode purescript"><code class="sourceCode purescript"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Op</span> b a <span class="ot">=</span> <span class="dt">Op</span> (a <span class="ot">-&gt;</span> b)</span></code></pre></div>
<p>as our “target”: turning an <code>NType a</code> into an <code>Op String a</code>. And an <code>Op String a</code> is an <code>a -&gt; String</code>, which is what we wanted! The <code>int</code> field is <code>Op String Int</code>, the <code>number</code> field is <code>Op String Number</code>, etc.</p>
<p>In many languages, using this technique effectively requires having a newtype wrapper on-hand, so it might be unwieldy in non-trivial situations. For example, if we wanted to write our previous axis function which is <code>NType a -&gt; [a] -&gt; String</code>, we’d have to have a newtype wrapper for <code>[a] -&gt; String</code> that has <code>a</code> as its argument:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode purescript"><code class="sourceCode purescript"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">OpList</span> b a <span class="ot">=</span> <span class="dt">Op</span> ([a] <span class="ot">-&gt;</span> b)</span></code></pre></div>
<p>or you could re-use <code>Compose</code>:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode purescript"><code class="sourceCode purescript"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Compose</span> f g a <span class="ot">=</span> <span class="dt">Compose</span> (f (g a))</span></code></pre></div>
<p>and your <code>p</code> projection type would be <code>Compose Op []</code>. So, you don’t necessarily have to write a bespoke newtype wrapper, but you do have to devote some brain cycles to think it through (unless you’re in a language that doesn’t need newtype wrappers to have this work, like we’ll discuss later).</p>
<p>By the way, this method generalizes well to multiple arguments: if you have a type like <code>MyGADT a b c</code>, you just need to project into a <code>forall (p :: k1 -&gt; k2 -&gt; k3 -&gt; Type)</code>.</p>
<p>I believe I have read somewhere that the two methods discussed here (runtime equality witness vs. higher-kinded eliminator) are not actually fully identical in their power, and there are GADTs where one would work and not the other … but I can’t remember where I read this and I’m also not big-brained enough to figure out what those situations are. But if you, reader, have any idea, please let me know!</p>
<h3 id="existential-types">Existential Types</h3>
<p>Let’s take a quick break to talk about something that’s not <em>technically</em> related to GADTs but is often used alongside them.</p>
<p>What if we wanted to store a value with its <code>NType</code> and hide the type variable? In Haskell we’d write this like:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">NType</span><span class="ot"> ::</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NInt</span><span class="ot"> ::</span> <span class="dt">NType</span> <span class="dt">Int</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NDouble</span><span class="ot"> ::</span> <span class="dt">NType</span> <span class="dt">Double</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NPercent</span><span class="ot"> ::</span> <span class="dt">NType</span> <span class="dt">Percent</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">SomeNType</span> <span class="ot">=</span> <span class="kw">forall</span> a<span class="op">.</span> <span class="dt">SomeNType</span> (<span class="dt">NType</span> a) a</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="ot">formatNType ::</span> <span class="dt">NType</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>formatNType nt x <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="ot">formatSomeNType ::</span> <span class="dt">SomeNType</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>formatSomeNType (<span class="dt">SomeNType</span> nt x) <span class="ot">=</span> formatNType nt x</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="ot">myFavoriteNumbers ::</span> [<span class="dt">SomeNType</span>]</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>myFavoriteNumbers <span class="ot">=</span> [<span class="dt">SomeNType</span> <span class="dt">NInt</span> <span class="dv">3</span>, <span class="dt">SomeNType</span> <span class="dt">NDouble</span> <span class="fu">pi</span>]</span></code></pre></div>
<p>But what if our language doesn’t have existentials? Remember, this is basically a value <code>SomeNType</code> that <em>isn’t</em> a Generic, but <em>contains</em> both a <code>NType a</code> and an <code>a</code> of the <em>same</em> variable.</p>
<p>One strategy we have available is to CPS-transform our existentials into their CPS form (continuation-passing style form). Basically, we write exactly what we want to do with our contents <em>if we pattern matched</em> on them. It’s essentially a Rank-N visitor pattern with only a single constructor:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode purescript"><code class="sourceCode purescript"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">SomeNType</span> <span class="ot">=</span> <span class="kw">forall</span> r<span class="op">.</span> (<span class="kw">forall</span> a<span class="op">.</span> <span class="dt">NType</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> r) <span class="ot">-&gt;</span> r</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="ot">someNType ::</span> <span class="dt">NType</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">SomeNType</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>someNType nt x <span class="ot">=</span> \f <span class="ot">-&gt;</span> f nt x</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="ot">formatSomeNumeric ::</span> <span class="dt">SomeNType</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>formatSomeNumeric snt <span class="ot">=</span> snt</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    \nt x <span class="ot">-&gt;</span> formatNumeric nt x</span></code></pre></div>
<p>You can imagine, syntactically, that <code>snt</code> acts as its “own” pattern match, except instead of matching on <code>SomeNType nt x -&gt; ..</code>, you “match” on <code>\nt x -&gt; ..</code></p>
<p>This general pattern works for languages with traditional generics like Java too:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> SomeNTypeVisitor<span class="op">&lt;</span>R<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>A<span class="op">&gt;</span> R <span class="fu">visit</span><span class="op">(</span>NType<span class="op">&lt;</span>A<span class="op">&gt;</span> nt<span class="op">,</span> A val<span class="op">);</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> SomeNType <span class="op">{</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">abstract</span> <span class="op">&lt;</span>R<span class="op">&gt;</span> R <span class="fu">accept</span><span class="op">(</span>SomeNTypeVisitor<span class="op">&lt;</span>R<span class="op">&gt;</span> visitor<span class="op">);</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// One option: the factory method</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="op">&lt;</span>A<span class="op">&gt;</span> SomeNType <span class="fu">someNType</span><span class="op">(</span>NType<span class="op">&lt;</span>A<span class="op">&gt;</span> nt<span class="op">,</span> A val<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">SomeNType</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="op">&lt;</span>R<span class="op">&gt;</span> R <span class="fu">accept</span><span class="op">(</span>SomeNTypeVisitor<span class="op">&lt;</span>R<span class="op">&gt;</span> visitor<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> visitor<span class="op">.</span><span class="fu">visit</span><span class="op">(</span>nt<span class="op">,</span> val<span class="op">);</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Second option: the subtype hiding a type variable, which you have to always</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a><span class="co">// make sure to upcast into `SomeNType` after creating</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SomeNTypeImpl<span class="op">&lt;</span>A<span class="op">&gt;</span> <span class="kw">extends</span> SomeNType <span class="op">{</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> NType<span class="op">&lt;</span>A<span class="op">&gt;</span> nt<span class="op">;</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> A val<span class="op">;</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">SomeNTypeImpl</span><span class="op">(</span>NType<span class="op">&lt;</span>A<span class="op">&gt;</span> nt<span class="op">,</span> A val<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">nt</span> <span class="op">=</span> nt<span class="op">;</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">val</span> <span class="op">=</span> val<span class="op">;</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="op">&lt;</span>R<span class="op">&gt;</span> R <span class="fu">accept</span><span class="op">(</span>SomeNTypeVisitor<span class="op">&lt;</span>R<span class="op">&gt;</span> visitor<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> visitor<span class="op">.</span><span class="fu">visit</span><span class="op">(</span>nt<span class="op">,</span> val<span class="op">);</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Does…anyone write java like this? I tried committing this once while at Google and I got automatically flagged to be put on a PIP.</p>
<h3 id="recursive-gadts">Recursive GADTs</h3>
<p>The climax of this discussion: what if your language does not support GADTs <em>or</em> recursive data types?</p>
<p>We’re going to be using <em>dhall</em> as an example again, but note that the lessons applied here are potentially useful even when you <em>do</em> have recursive types: we’re going to be talking about a higher-kinded church encoding, which can be a useful form of your data types that live alongside your normal recursive ones.</p>
<p>Let’s imagine <code>Expr</code> as a GADT, where <code>Expr a</code> represents an <code>Expr</code> that evaluates to an <code>a</code>:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Expr</span><span class="ot"> ::</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NatLit</span><span class="ot"> ::</span> <span class="dt">Natural</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> <span class="dt">Natural</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">BoolLit</span><span class="ot"> ::</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> <span class="dt">Bool</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Add</span><span class="ot"> ::</span> <span class="dt">Expr</span> <span class="dt">Natural</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> <span class="dt">Natural</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> <span class="dt">Natural</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LTE</span><span class="ot"> ::</span> <span class="dt">Expr</span> <span class="dt">Natural</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> <span class="dt">Natural</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> <span class="dt">Bool</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Ternary</span><span class="ot"> ::</span> <span class="dt">Expr</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> a <span class="ot">-&gt;</span> <span class="dt">Expr</span> a <span class="ot">-&gt;</span> <span class="dt">Expr</span> a</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="ot">eval ::</span> <span class="dt">Expr</span> a <span class="ot">-&gt;</span> a</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>eval <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NatLit</span> n <span class="ot">-&gt;</span> n</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">BoolLit</span> b <span class="ot">-&gt;</span> b</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Add</span> x y <span class="ot">-&gt;</span> eval x <span class="op">+</span> eval y</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LTE</span> a b <span class="ot">-&gt;</span> eval a <span class="op">&lt;=</span> eval b</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Ternary</span> b x y <span class="ot">-&gt;</span> <span class="kw">if</span> eval b <span class="kw">then</span> eval x <span class="kw">else</span> eval y</span></code></pre></div>
<p>Adding this type variable ensures that our <code>Expr</code> is type-safe: it’s impossible to <code>Add</code> an <code>Expr Bool</code>, and the two branches of a <code>Ternary</code> must have the same result type, etc. And, we can write <code>eval :: Expr a -&gt; a</code> and know exactly what type will be returned.</p>
<p>Now, let’s combine the two concepts: First, the church encoding, where our handlers take the “final result” of our fold <code>r</code> instead of the recursive value <code>Expr</code>. Second, the higher-kinded eliminator pattern where we embed <code>Expr :: Type -&gt; Type</code> into <code>forall (p :: Type -&gt; Type)</code>.</p>
<p>And finally, we get:<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode dhall"><code class="sourceCode "><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span><span class="co"> </span>ExprF<span class="co"> </span>=</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co">      </span><span class="op">\</span>(p<span class="co"> </span>:<span class="co"> </span>Type<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co">        </span>{<span class="co"> </span>natLit<span class="co"> </span>:<span class="co"> </span>Natural<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>p<span class="co"> </span>Natural</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co">        </span>,<span class="co"> </span>boolLit<span class="co"> </span>:<span class="co"> </span>Bool<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>p<span class="co"> </span>Bool</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co">        </span>,<span class="co"> </span>add<span class="co"> </span>:<span class="co"> </span>p<span class="co"> </span>Natural<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>p<span class="co"> </span>Natural<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>p<span class="co"> </span>Natural</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co">        </span>,<span class="co"> </span>ternary<span class="co"> </span>:<span class="co"> </span><span class="kw">forall</span><span class="co"> </span>(a<span class="co"> </span>:<span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>p<span class="co"> </span>Bool<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>p<span class="co"> </span>a<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>p<span class="co"> </span>a<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>p<span class="co"> </span>a</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co">        </span>}</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span><span class="co"> </span>Expr</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span>:<span class="co"> </span>Type<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Type</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span>=<span class="co"> </span><span class="op">\</span>(a<span class="co"> </span>:<span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span><span class="kw">forall</span><span class="co"> </span>(p<span class="co"> </span>:<span class="co"> </span>Type<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>ExprF<span class="co"> </span>p<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>p<span class="co"> </span>a</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span><span class="co"> </span>eval</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="co">    </span>:<span class="co"> </span><span class="kw">forall</span><span class="co"> </span>(a<span class="co"> </span>:<span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Expr<span class="co"> </span>a<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>a</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="co">    </span>=<span class="co"> </span><span class="op">\</span>(a<span class="co"> </span>:<span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a><span class="co">      </span><span class="op">\</span>(e<span class="co"> </span>:<span class="co"> </span>Expr<span class="co"> </span>a)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="co">        </span>e</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a><span class="co">          </span>(<span class="op">\</span>(q<span class="co"> </span>:<span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>q)</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a><span class="co">          </span>{<span class="co"> </span>natLit<span class="co"> </span>=<span class="co"> </span><span class="op">\</span>(x<span class="co"> </span>:<span class="co"> </span>Natural)<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>x</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a><span class="co">          </span>,<span class="co"> </span>boolLit<span class="co"> </span>=<span class="co"> </span><span class="op">\</span>(x<span class="co"> </span>:<span class="co"> </span>Bool)<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>x</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a><span class="co">          </span>,<span class="co"> </span>add<span class="co"> </span>=<span class="co"> </span><span class="op">\</span>(x<span class="co"> </span>:<span class="co"> </span>Natural)<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span><span class="op">\</span>(y<span class="co"> </span>:<span class="co"> </span>Natural)<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>x<span class="co"> </span>+<span class="co"> </span>y</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a><span class="co">          </span>,<span class="co"> </span>ternary<span class="co"> </span>=</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a><span class="co">              </span><span class="op">\</span>(a<span class="co"> </span>:<span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a><span class="co">              </span><span class="op">\</span>(b<span class="co"> </span>:<span class="co"> </span>Bool)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a><span class="co">              </span><span class="op">\</span>(x<span class="co"> </span>:<span class="co"> </span>a)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a><span class="co">              </span><span class="op">\</span>(y<span class="co"> </span>:<span class="co"> </span>a)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a><span class="co">                </span><span class="kw">if</span><span class="co"> </span>b<span class="co"> </span><span class="kw">then</span><span class="co"> </span>x<span class="co"> </span><span class="kw">else</span><span class="co"> </span>y</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a><span class="co">          </span>}</span></code></pre></div>
<p>Again, now instead of <code>add</code> taking <code>Expr</code>, it takes <code>p Natural</code>: the “<code>Natural</code> result of the fold”. <code>p</code> not only stands in for what we embed <code>Expr</code> into, it stands in for the result of the recursive fold. That’s why in <code>eval</code>, the first arguments of <code>add</code> are the <code>Natural</code> results of the sub-evaluation.</p>
<p>These values can be created in the same way as before, merging the two techniques, sending the handlers downstream:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode dhall"><code class="sourceCode "><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span><span class="co"> </span>natLit</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co">    </span>:<span class="co"> </span>Natural<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Expr<span class="co"> </span>Natural</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co">    </span>=<span class="co"> </span><span class="op">\</span>(n<span class="co"> </span>:<span class="co"> </span>Natural)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co">      </span><span class="op">\</span>(p<span class="co"> </span>:<span class="co"> </span>Type<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co">      </span><span class="op">\</span>(handlers<span class="co"> </span>:<span class="co"> </span>ExprF<span class="co"> </span>p)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co">        </span>handlers.natLit<span class="co"> </span>n</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span><span class="co"> </span>boolLit</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span>:<span class="co"> </span>Bool<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Expr<span class="co"> </span>Bool</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span>=<span class="co"> </span><span class="op">\</span>(n<span class="co"> </span>:<span class="co"> </span>Bool)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="co">      </span><span class="op">\</span>(p<span class="co"> </span>:<span class="co"> </span>Type<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="co">      </span><span class="op">\</span>(handlers<span class="co"> </span>:<span class="co"> </span>ExprF<span class="co"> </span>p)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="co">        </span>handlers.boolLit<span class="co"> </span>n</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span><span class="co"> </span>add</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="co">    </span>:<span class="co"> </span>Expr<span class="co"> </span>Natural<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Expr<span class="co"> </span>Natural<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Expr<span class="co"> </span>Natural</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="co">    </span>=<span class="co"> </span><span class="op">\</span>(x<span class="co"> </span>:<span class="co"> </span>Expr<span class="co"> </span>Natural)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a><span class="co">      </span><span class="op">\</span>(y<span class="co"> </span>:<span class="co"> </span>Expr<span class="co"> </span>Natural)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="co">      </span><span class="op">\</span>(p<span class="co"> </span>:<span class="co"> </span>Type<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a><span class="co">      </span><span class="op">\</span>(handlers<span class="co"> </span>:<span class="co"> </span>ExprF<span class="co"> </span>p)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a><span class="co">        </span>handlers.add<span class="co"> </span>(x<span class="co"> </span>p<span class="co"> </span>handlers)<span class="co"> </span>(y<span class="co"> </span>p<span class="co"> </span>handlers)</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span><span class="co"> </span>ternary</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a><span class="co">    </span>:<span class="co"> </span><span class="kw">forall</span><span class="co"> </span>(a<span class="co"> </span>:<span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Expr<span class="co"> </span>Bool<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Expr<span class="co"> </span>a<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Expr<span class="co"> </span>a<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Expr<span class="co"> </span>a</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a><span class="co">    </span>=<span class="co"> </span><span class="op">\</span>(a<span class="co"> </span>:<span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a><span class="co">      </span><span class="op">\</span>(b<span class="co"> </span>:<span class="co"> </span>Expr<span class="co"> </span>Bool)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a><span class="co">      </span><span class="op">\</span>(x<span class="co"> </span>:<span class="co"> </span>Expr<span class="co"> </span>a)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a><span class="co">      </span><span class="op">\</span>(y<span class="co"> </span>:<span class="co"> </span>Expr<span class="co"> </span>a)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a><span class="co">      </span><span class="op">\</span>(p<span class="co"> </span>:<span class="co"> </span>Type<span class="co"> </span><span class="op">-&gt;</span><span class="co"> </span>Type)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a><span class="co">      </span><span class="op">\</span>(handlers<span class="co"> </span>:<span class="co"> </span>ExprF<span class="co"> </span>p)<span class="co"> </span><span class="op">-&gt;</span></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a><span class="co">        </span>handlers.ternary<span class="co"> </span>(b<span class="co"> </span>p<span class="co"> </span>handlers)<span class="co"> </span>(x<span class="co"> </span>p<span class="co"> </span>handlers)<span class="co"> </span>(y<span class="co"> </span>p<span class="co"> </span>handlers)</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span><span class="co"> </span>testVal</span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a><span class="co">    </span>:<span class="co"> </span>Expr<span class="co"> </span>Natural</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a><span class="co">    </span>=<span class="co"> </span>add<span class="co"> </span>(natLit<span class="co"> </span><span class="dv">5</span>)<span class="co"> </span>(add<span class="co"> </span>(natLit<span class="co"> </span><span class="dv">6</span>)<span class="co"> </span>(natLit<span class="co"> </span><span class="dv">7</span>))</span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span><span class="co">  </span><span class="kw">assert</span><span class="co"> </span>:<span class="co"> </span>eval<span class="co"> </span>testVal<span class="co"> </span><span class="op">===</span><span class="co"> </span><span class="dv">18</span></span></code></pre></div>
<p>If all of this is difficult to parse, try reviewing both the recursive ADT section and the higher-kinded eliminator section and making sure you understand both well before tackling this, which combines them together!</p>
<p>Admittedly in Haskell (and purescript) this is a lot simpler because we don’t have to explicitly pass in type variables:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">ExprF</span> p <span class="ot">=</span> <span class="dt">ExprF</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> natLit ::</span> <span class="dt">Natural</span> <span class="ot">-&gt;</span> p <span class="dt">Natural</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> boolLit ::</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> p <span class="dt">Bool</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> add ::</span> p <span class="dt">Natural</span> <span class="ot">-&gt;</span> p <span class="dt">Natural</span> <span class="ot">-&gt;</span> p <span class="dt">Natural</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> ternary ::</span> <span class="kw">forall</span> a<span class="op">.</span>  p <span class="dt">Bool</span> <span class="ot">-&gt;</span> p a <span class="ot">-&gt;</span> p a <span class="ot">-&gt;</span> p a</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Expr</span> a <span class="ot">=</span> <span class="kw">forall</span> p<span class="op">.</span> <span class="dt">ExprF</span> p a <span class="ot">-&gt;</span> p a</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="ot">eval ::</span> <span class="dt">Expr</span> a <span class="ot">-&gt;</span> a</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>eval e <span class="ot">=</span> runIdentity <span class="op">$</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  e</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    { natLit <span class="ot">=</span> <span class="dt">Identity</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    , boolLit <span class="ot">=</span> <span class="dt">Identity</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>    , add <span class="ot">=</span> \(<span class="dt">Identity</span> x) <span class="ot">-&gt;</span> \(<span class="dt">Identity</span> y) <span class="ot">-&gt;</span> <span class="dt">Identity</span> (x <span class="op">+</span> y)</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    , ternary <span class="ot">=</span> \(<span class="dt">Identity</span> b) <span class="ot">-&gt;</span> \(<span class="dt">Identity</span> x) <span class="ot">-&gt;</span> \(<span class="dt">Identity</span> y) <span class="ot">-&gt;</span> <span class="kw">if</span> b <span class="kw">then</span> x <span class="kw">else</span> y</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a><span class="ot">ternary ::</span> <span class="dt">Expr</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">Expr</span> a <span class="ot">-&gt;</span> <span class="dt">Expr</span> a <span class="ot">-&gt;</span> <span class="dt">Expr</span> a</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>ternary b x y handlers <span class="ot">=</span> handlers<span class="op">.</span>ternary (b handlers) (x handlers) (y handlers)</span></code></pre></div>
<p>But one nice thing about the dhall version that’s incidental to dhall is that it doesn’t require any extra newtype wrappers like the Haskell one does. That’s because type inference tends to choke on things like this, but dhall doesn’t really have any type inference: all of the types are passed explicitly. It’s one of the facts about dhall that make it nice for things like this.</p>
<h2 id="congratulations">Congratulations</h2>
<p>In any case, if you’ve made it this far, congratulations! You are a master of ADTs and GADTs. Admittedly every language is different, and some of these solutions have to be tweaked for the language in question. And, if your program gets very complicated, there is a good chance that things will become ergonomically unfeasible.</p>
<p>But I hope, at least, that this inspires your imagination to try to bring your haskell principles, techniques, standards, practices, and brainrot into the language of your choice (or language you are forced to work with).</p>
<p>And, if you ever find interesting ways to bring these things into a language not discussed here (or a new interesting technique or pattern), I would absolutely love to hear about it!</p>
<p>Until next time, happy “Haskelling”!</p>
<h2 id="special-thanks">Special Thanks</h2>
<p>I am very humbled to be supported by an amazing community, who make it possible for me to devote time to researching and writing these posts. Very special thanks to my supporter at the “Amazing” level on <a href="https://www.patreon.com/justinle/overview">patreon</a>, Josh Vera! :)</p>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>I bet you thought there was going be some sort of caveat in this footnote, didn’t you?<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>I didn’t think I’d ever write “java bean” non-ironically on my blog, but there’s a first time for everything.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Be aware that this implementation is not necessarily appropriately lazy or short-circuiting in <code>Ternary</code>: it might evaluate both sides returning the chosen branch.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div><footer><hr><div class="copy-content"><p>Hi, thanks for reading! You can reach me via email at <a href="mailto:justin@jle.im" class="email">justin@jle.im</a>, or at twitter at <a href="https://twitter.com/mstk">@mstk</a>! This post and all others are published under the <a href="https://creativecommons.org/licenses/by-nc-nd/3.0/">CC-BY-NC-ND 3.0</a> license. Corrections and edits via pull request are welcome and encouraged at <a href="https://github.com/mstksg/inCode">the source repository</a>.</p>
<p>If you feel inclined, or this post was particularly helpful for you, why not consider <a href="https://www.patreon.com/justinle/overview">supporting me on Patreon</a>, or a <a href="bitcoin:3D7rmAYgbDnp4gp4rf22THsGt74fNucPDU">BTC donation</a>? :)</p></div><div class="clear"></div><ul class="entry-series"></ul><ul class="tag-list"><li><a href="https://blog.jle.im/entries/tagged/dhall.html" class="tag-a-tag">#dhall</a></li><li><a href="https://blog.jle.im/entries/tagged/functional-programming.html" class="tag-a-tag">#functional programming</a></li><li><a href="https://blog.jle.im/entries/tagged/haskell.html" class="tag-a-tag">#haskell</a></li><li><a href="https://blog.jle.im/entries/tagged/java.html" class="tag-a-tag">#java</a></li><li><a href="https://blog.jle.im/entries/tagged/purescript.html" class="tag-a-tag">#purescript</a></li><li><a href="https://blog.jle.im/entries/category/@haskell.html" class="tag-a-category">@HASKELL</a></li></ul><aside class="social-buttons"><div class="addthis_toolbox addthis_default_style addthis-buttons"><a class="addthis_button_facebook_like" fb:like:layout="button_count"></a><a class="addthis_button_tweet"></a><a class="addthis_button_google_plusone" g:plusone:size="medium"></a><a class="addthis_counter addthis_pill_style"></a></div><div class="custom-social-buttons"><div class="custom-social-button"><a href="https://www.reddit.com/submit" onclick="window.location = &#39;https://www.reddit.com/submit?url=&#39;+ encodeURIComponent(window.location); return false"><img src="https://www.reddit.com/static/spreddit7.gif" alt="submit to reddit"></a></div></div></aside><nav class="next-prev-links"><ul><li class="prev-entry-link">&larr; <a href="https://blog.jle.im/entry/sum-types-and-subtypes-and-unions.html">Sum Types and Subtypes and Unions</a> (Previous)</li><li class="next-entry-link">(Next) <a href="https://blog.jle.im/entry/the-baby-paradox-in-haskell.html">The Baby Paradox in Haskell</a> &rarr;</li></ul></nav></footer></article><div class="post-entry"><div class="tile"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://blog.jle.im/entry/faking-adts-and-gadts.html';
    this.page.identifier = 'faking-adts-and-gadts';
};
(function() {
    var d = document, s = d.createElement('script');
    s.src = '//incode.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a><br></noscript><a href="http://disqus.com" class="dsq-brlink">Comments powered by <span class="logo-disqus">Disqus</span></a></div></div></div></div></div><div id="footer-container"><div id="footer-content"><div class="tile"><div class="footer-copyright">&copy; 2020 Justin Le <span class="license-link">(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/" class="license">CC-BY-NC-ND 3.0</a>)</span></div><div class="footer-follow social-follows"><ul class="social-follows-list"><li><ul class="social-follows-list-social"><li><a class="social-follow-twitter" title="Follow me on Twitter!" href="https://twitter.com/intent/user?user_id=mstk" onclick="window.open(
  &#39;http://twitter.com/intent/user?user_id=907281&#39;,
  &#39;facebook-share-dialog&#39;,
  &#39;width=550,height=520&#39;);
return false;
">Twitter</a></li><li><a class="social-follow-github" title="Fork me on Github!" href="https://github.com/mstksg">Github</a></li><li><a class="social-follow-twitch" title="Watch me on Twitch!" href="https://www.twitch.tv/justin_l">Twitch</a></li><li><a class="social-follow-patreon" title="Support me on Patreon!" href="https://www.patreon.com/justinle/overview">Patreon</a></li><li><a class="social-follow-gplus" title="Add me on Google+!" href="https://plus.google.com/+JustinLe">Google+</a></li><li><a class="social-follow-keybase" title="Track me on Keybase!" href="https://keybase.io/mstksg">Keybase</a></li><li><a class="social-follow-linkedin" title="Connect with me on LinkedIn!" href="https://linkedin.com/in/lejustin">LinkedIn</a></li><li><a class="social-follow-bitcoin" title="Donate via bitcoin!" href="bitcoin:3D7rmAYgbDnp4gp4rf22THsGt74fNucPDU">Bitcoin</a></li></ul></li><li><ul class="social-follows-list-site"><li><a class="social-follow-rss" title="Subscribe to my RSS Feed!" href="http://feeds.feedburner.com/incodeblog">RSS</a></li><li><a class="social-follow-email" title="Subscribe to the mailing list!" href="https://feedburner.google.com/fb/a/mailverify?loc=en_US&amp;uri=incodeblog">Mailing list</a></li></ul></li></ul></div></div></div></div></body></html>