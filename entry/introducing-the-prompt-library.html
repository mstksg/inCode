<!DOCTYPE HTML>
<html><head><title>Introducing the &quot;Prompt&quot; library · in Code</title><meta name="description" content="Weblog of Justin Le, covering various adventures in programming and explorations in the worlds of computation physics, and knowledge.
"><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><meta name="flattr:id" content="3p9jqr"><meta property="og:site_name" content="in Code"><meta property="og:description" content="Prompt: README / hackage / github Have you ever wanted to specify a computation involving some limited form of IO — like querying a database, or asking stdio — but didn’t want a computation in the IO monad, opening the entire can of worms that is arbitrary IO? Have you ever looked at complicated IO a you wrote last week at 4am and prayed that it didn’t launch missiles if you decided to execute it? Do you want to be able to run an effectful computation and explicitly say what IO it can or cannot do? Introducing the prompt library! It’s a small little lightweight library that allows you to specify and describe computations involving forms of effects where you “ask” with a value and receive a value in return (such as a database query, etc.), but not ever care about how the effects are fulfilled — freeing you from working directly with IO. data Foo = Foo { fooBar :: String , fooBaz :: Int } deriving Show -- ask with a String, receive a String as an answer promptFoo :: Prompt String String Foo promptFoo = Foo &lt;$&gt; prompt &quot;bar&quot; &lt;*&gt; fmap length (prompt &quot;baz&quot;)"><meta property="og:type" content="article"><meta property="og:title" content="Introducing the &quot;Prompt&quot; library"><meta property="og:image" content="https://blog.jle.im/img/site_logo.jpg"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://blog.jle.im/entry/introducing-the-prompt-library.html"><meta name="twitter:card" content="summary"><meta name="twitter:creator:id" content="mstk"><link rel="author" href="https://plus.google.com/107705320197444500140"><link rel="alternate" type="application/rss+xml" title="in Code (RSS Feed)" href="http://feeds.feedburner.com/incodeblog"><link rel="canonical" href="https://blog.jle.im/entry/introducing-the-prompt-library.html"><link href="https://blog.jle.im/favicon.ico" rel="shortcut icon"><link href="https://blog.jle.im/css/toast.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/font.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/main.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/page/entry.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/pygments.css" rel="stylesheet" type="text/css"><script type="text/javascript">var page_data = {};
var disqus_shortname='incode';
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-443711-8', 'jle.im');
ga('send', 'pageview');
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id="MathJax-script" async="" src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js"></script><script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5234d67a6b68dcd4"></script><script type="text/javascript" src="https://blog.jle.im/js/page/entry_toc.js"></script><script type="text/javascript" src="https://blog.jle.im/js/disqus_count.js"></script><script type="text/javascript" src="https://blog.jle.im/js/social.js"></script><script type="text/javascript" src="https://blog.jle.im/js/jquery/jquery.toc.js"></script><script type="text/javascript" src="https://blog.jle.im/purescript/entry.js"></script></head><body><div id="fb-root"><script>(function(d, s, id) {
 var js, fjs = d.getElementsByTagName(s)[0];
 if (d.getElementById(id)) return;
 js = d.createElement(s); js.id = id;
 js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=641852699171929";
 fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script></div><div id="header-container"><div id="navbar-container" class="tile"><nav id="navbar-content"><div class="nav-info"><h1 class="site-title"><a href="https://blog.jle.im/" class="nav-title">in Code</a></h1><span class="nav-author">Justin Le</span></div><ul class="nav-links"><li><a href="https://blog.jle.im/">home</a></li><li><a href="https://blog.jle.im/entries.html">archives</a></li><li><a href="https://cv.jle.im">cv</a></li><div class="clear"></div></ul></nav></div><div id="header-content"></div></div><div id="body-container" class="container"><div id="main-container" class="grid"><div class="entry-section unit span-grid" role="main"><article class="tile article"><header><h1 id="title">Introducing the &quot;Prompt&quot; library</h1><p class="entry-info">by <a class="author" href="https://blog.jle.im/">Justin Le</a><span class="info-separator"> &diams; </span><time datetime="2015-06-30T09:42:11Z" pubdate="" class="pubdate">Tuesday June 30, 2015</time></p><p><span class="source-info"><a class="source-link" href="https://github.com/mstksg/inCode/tree/master/copy/entries/prompt.md">Source</a><span class="info-separator"> &diams; </span><a class="source-link" href="https://github.com/mstksg/inCode/tree/gh-pages/entry/introducing-the-prompt-library.md">Markdown</a><span class="info-separator"> &diams; </span><a class="source-link" href="https://blog.jle.im/entry/introducing-the-prompt-library.tex">LaTeX</a><span class="info-separator"> &diams; </span></span>Posted in <a href="https://blog.jle.im/entries/category/@haskell.html" class="tag-a-category" title="Functional, pure, non-strict, statically and strongly typed, natively
compiled...really just the king of great languages.
">Haskell</a>, <a href="https://blog.jle.im/entries/category/@projects.html" class="tag-a-category" title="Progress or presentations of completed or ongoing open source projects I have
worked/am working on. Hopefully either the development process or the end
product can be useful to someone!
">Projects</a><span class="info-separator"> &diams; </span><a class="comment-link" href="#disqus_thread">Comments</a></p></header><hr><aside class="contents-container"><h5 id="contents-header">Contents</h5><div id="toc"></div></aside><div class="main-content copy-content"><p><strong>Prompt</strong>: <a href="https://github.com/mstksg/prompt/blob/master/README.md">README</a> / <a href="http://hackage.haskell.org/package/prompt">hackage</a> / <a href="https://github.com/mstksg/prompt">github</a></p>
<p>Have you ever wanted to specify a computation involving some limited form of IO — like querying a database, or asking stdio — but didn’t want a computation in the <code>IO</code> monad, opening the entire can of worms that is arbitrary <code>IO</code>? Have you ever looked at complicated <code>IO a</code> you wrote last week at 4am and prayed that it didn’t launch missiles if you decided to execute it? Do you want to be able to run an effectful computation and explicitly <em>say</em> what IO it can or cannot do?</p>
<p>Introducing the <em><a href="http://hackage.haskell.org/package/prompt">prompt</a></em> library! It’s a small little lightweight library that allows you to specify and describe computations involving forms of effects where you “ask” with a value and receive a value in return (such as a database query, etc.), but not ever care about how the effects are fulfilled — freeing you from working directly with IO.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Foo</span> <span class="ot">=</span> <span class="dt">Foo</span> {<span class="ot"> fooBar ::</span> <span class="dt">String</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>               ,<span class="ot"> fooBaz ::</span> <span class="dt">Int</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>               } <span class="kw">deriving</span> <span class="dt">Show</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- ask with a String, receive a String as an answer</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="ot">promptFoo ::</span> <span class="dt">Prompt</span> <span class="dt">String</span> <span class="dt">String</span> <span class="dt">Foo</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>promptFoo <span class="ot">=</span> <span class="dt">Foo</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;$&gt;</span> prompt <span class="st">&quot;bar&quot;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;*&gt;</span> <span class="fu">fmap</span> <span class="fu">length</span> (prompt <span class="st">&quot;baz&quot;</span>)</span></code></pre></div>
<h2 id="running">Running</h2>
<p>You can now “run it” in IO, by talking to stdio —</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> runPromptM promptFoo <span class="op">$</span> \str <span class="ot">-&gt;</span> <span class="fu">putStrLn</span> str <span class="op">&gt;&gt;</span> <span class="fu">getLine</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>bar                 <span class="co">-- stdout prompt</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> hello<span class="op">!</span>            <span class="co">-- stdin response typed in</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>baz                 <span class="co">-- stdout prompt</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> i am baz          <span class="co">-- stdin response typed in</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="dt">Foo</span> <span class="st">&quot;hello!&quot;</span> <span class="dv">8</span>      <span class="co">-- result</span></span></code></pre></div>
<p>(this is also just <code>interactP promptFoo</code>)</p>
<p>Or you can maybe request it from the environment variables:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="kw">import</span> <span class="dt">System.Environment</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> setEnv <span class="st">&quot;bar&quot;</span> <span class="st">&quot;hello!&quot;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> setEnv <span class="st">&quot;baz&quot;</span> <span class="st">&quot;i am baz&quot;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> runPromptM promptFoo getEnv</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="dt">Foo</span> <span class="st">&quot;hello!&quot;</span> <span class="dv">8</span></span></code></pre></div>
<p>Or maybe you want to fulfill the prompts purely:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map</span> <span class="kw">as</span> <span class="dt">M</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="kw">let</span> testMap <span class="ot">=</span> M.fromList [(<span class="st">&quot;bar&quot;</span>, <span class="st">&quot;hello!&quot;</span>), (<span class="st">&quot;baz&quot;</span>, <span class="st">&quot;i am baz&quot;</span>)]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> runPrompt promptFoo (testMap <span class="op">M.!</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="dt">Foo</span> <span class="st">&quot;hello!&quot;</span> <span class="dv">8</span></span></code></pre></div>
<p>With <code>Prompt</code>, specify the computation and your logic <em>without involving any IO</em>, so you can write safe code without arbitrary side effects. If you ever receive a <code>Prompt</code>, you know it can’t wipe out your hard drive or do any IO other than exactly what you allow it to do! I’d feel more safe running a <code>Prompt a b r</code> than an <code>IO r</code>.</p>
<p>You can also do some cute tricks; <code>Prompt a () r</code> with a “prompt response function” like <code>putStrLn</code> lets you do streaming logging, and defer <em>how</em> the logging is done — to IO, to a list?</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> <span class="kw">let</span> logHelloWord <span class="ot">=</span> <span class="fu">mapM_</span> prompt [<span class="st">&quot;hello&quot;</span>, <span class="st">&quot;world&quot;</span>]</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> runPromptM logHelloWorld <span class="fu">putStrLn</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>hello</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>world</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> execWriter <span class="op">$</span> runPromptM logHelloWorld tell</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;helloworld&quot;</span></span></code></pre></div>
<p><code>Prompt () b r</code> is like a fancy <code>ReaderT b m r</code>, where you “defer” the choice of the Monad.</p>
<h2 id="combining-with-other-effects">Combining with other effects</h2>
<p><code>Prompt</code> can be used as an underlying “effects” source for libraries like <em>pipes</em>, <em>conduit</em>, and <em>auto</em>. If your effects are only ever asking and prompting and receiving, there’s really no need to put the entire power of <code>IO</code> underneath your DSL as an effects source. That’s just crazy!</p>
<p><code>Prompt</code> can be used with monad transformers to give you safe underlying effect sources, like <code>StateT s (Prompt a b) r</code>, which is a stateful computation which can sometimes sequence “prompty” effects. <code>Prompt</code> is also itself a “Traversable transformer”, with <code>PrompT a b t r</code>. It can perform computations in the context of a Traversable <code>t</code>, to be able to incorporate built-in short-circuiting and logging, etc.</p>
<p>This is all abstracted over with <code>MonadPrompt</code>, <code>MonadError</code>, <code>MonadPlus</code>, etc., typeclasses —</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ot">promptFoo2 ::</span> (<span class="dt">MonadPlus</span> m, <span class="dt">MonadPrompt</span> <span class="dt">String</span> <span class="dt">String</span> m) <span class="ot">=&gt;</span> m <span class="dt">Foo</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>promptFoo2 <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    bar <span class="ot">&lt;-</span> prompt <span class="st">&quot;bar&quot;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    str <span class="ot">&lt;-</span> prompt <span class="st">&quot;baz&quot;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> readMaybe str <span class="kw">of</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Just</span> baz <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">Foo</span> bar baz</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Nothing</span>  <span class="ot">-&gt;</span> mzero</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- more polymorphic</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="ot">promptFoo ::</span> <span class="dt">MonadPrompt</span> <span class="dt">String</span> <span class="dt">String</span> m <span class="ot">=&gt;</span> m <span class="dt">Foo</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>promptFoo <span class="ot">=</span> <span class="dt">Foo</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;$&gt;</span> prompt <span class="st">&quot;bar&quot;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;*&gt;</span> <span class="fu">fmap</span> <span class="fu">length</span> (prompt <span class="st">&quot;baz&quot;</span>)</span></code></pre></div>
<p>You can run <code>promptFoo</code> as a <code>MaybeT (Prompt String String) Foo</code>, and manually unwrap:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> interactP <span class="op">.</span> runMaybeT <span class="op">$</span> promptFoo2</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>bar</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> hello<span class="op">!</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>baz</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> i am baz</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="dt">Nothing</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> interactP <span class="op">.</span> runMaybeT <span class="op">$</span> promptFoo2</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>bar</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> hello<span class="op">!</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>baz</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="dv">19</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="dt">Just</span> (<span class="dt">Foo</span> <span class="st">&quot;hello!&quot;</span> <span class="dv">19</span>)</span></code></pre></div>
<p>Or you can run it as a <code>PromptT String String MaybeT Foo</code>, to have <code>PromptT</code> handle the wrapping/unwrapping itself:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> interactPT promptFoo2</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>bar</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> hello<span class="op">!</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>baz</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> i am baz</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="dt">Nothing</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> interactPT <span class="op">$</span> promptFoo2 <span class="op">&lt;|&gt;</span> promptFoo</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>bar</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> hello<span class="op">!</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>baz</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> i am baz</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>bar                 <span class="co">-- failed to parse --- retrying with promptFoo!</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> hello<span class="op">!</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>baz</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> i am baz</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="dt">Just</span> (<span class="dt">Foo</span> <span class="st">&quot;hello&quot;</span> <span class="dv">8</span>)</span></code></pre></div>
<p>The previous example of <code>logHelloWorld</code>?</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ghci<span class="op">&gt;</span> runPromptT (<span class="ot">logHelloWorld ::</span> <span class="dt">PromptT</span> <span class="dt">String</span> () (<span class="dt">Writer</span> <span class="dt">String</span>) ()) tell</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;helloworld&quot;</span></span></code></pre></div>
<h2 id="runners">Runners</h2>
<p>The “runners” are:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ot">interactP   ::</span>                  <span class="dt">Prompt</span>  <span class="dt">String</span> <span class="dt">String</span>   r <span class="ot">-&gt;</span> <span class="dt">IO</span> r</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ot">interactPT  ::</span> <span class="dt">Applicative</span> t <span class="ot">=&gt;</span> <span class="dt">PromptT</span> <span class="dt">String</span> <span class="dt">String</span> t r <span class="ot">-&gt;</span> <span class="dt">IO</span> (t r)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="ot">runPrompt   ::</span>                  <span class="dt">Prompt</span>  a b   r <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span>   b) <span class="ot">-&gt;</span> r</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ot">runPromptM  ::</span> <span class="dt">Monad</span> m       <span class="ot">=&gt;</span> <span class="dt">Prompt</span>  a b   r <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> m b) <span class="ot">-&gt;</span> m r</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="ot">runPromptT  ::</span>                  <span class="dt">PromptT</span> a b t r <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span>    t b)  <span class="ot">-&gt;</span> t r</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="ot">runPromptTM ::</span> <span class="dt">Monad</span> m       <span class="ot">=&gt;</span> <span class="dt">PromptT</span> a b t r <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> m (t b)) <span class="ot">-&gt;</span> m (t r)</span></code></pre></div>
<p>Note that <code>runPromptM</code> and <code>runPromptTM</code> can run in monads (like <code>IO</code>) that are <em>completely unrelated</em> to the <code>Prompt</code> type itself. It sequences them all “after the fact”. It’s also interesting to note that <code>runPrompt</code> is just a glorified <code>Reader (a -&gt; b) r</code>.</p>
<p>With <code>runPromptTM</code>, you can incorporate <code>t</code> in your “prompt response” function, too. Which brings us to our grand finale – environment variable parsing!</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Monad.Error.Class</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Monad.Prompt</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Text.Read</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map</span> <span class="kw">as</span> <span class="dt">M</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Key</span> <span class="ot">=</span> <span class="dt">String</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Val</span> <span class="ot">=</span> <span class="dt">String</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">MyError</span> <span class="ot">=</span> <span class="dt">MENoParse</span> <span class="dt">Key</span> <span class="dt">Val</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>             <span class="op">|</span> <span class="dt">MENotFound</span> <span class="dt">Key</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>             <span class="kw">deriving</span> <span class="dt">Show</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="ot">promptRead ::</span> (<span class="dt">MonadError</span> <span class="dt">MyError</span> m, <span class="dt">MonadPrompt</span> <span class="dt">Key</span> <span class="dt">Val</span> m, <span class="dt">Read</span> b)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>           <span class="ot">=&gt;</span> <span class="dt">Key</span> <span class="ot">-&gt;</span> m b</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">-- promptRead :: Read b =&gt; Key -&gt; PromptT Key Val (Either MyError) b</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>promptRead k <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    resp <span class="ot">&lt;-</span> prompt k</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> readMaybe resp <span class="kw">of</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> throwError <span class="op">$</span> <span class="dt">MEParse</span> k resp</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Just</span> v  <span class="ot">-&gt;</span> <span class="fu">return</span> v</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="ot">promptFoo3 ::</span> <span class="dt">MonadPrompt</span> <span class="dt">Key</span> <span class="dt">Val</span> m <span class="ot">=&gt;</span> m <span class="dt">Foo</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="co">-- promptFoo3 :: Applicative t =&gt; PromptT Key Val t Foo</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>promptFoo3 <span class="ot">=</span> <span class="dt">Foo</span> <span class="op">&lt;$&gt;</span> prompt <span class="st">&quot;bar&quot;</span> <span class="op">&lt;*&gt;</span> promptRead <span class="st">&quot;baz&quot;</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="co">-- running!</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="co">-- Lookup environment variables, and &quot;throw&quot; an error if not found</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="ot">throughEnv ::</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">MyError</span> <span class="dt">Foo</span>)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>throughEnv <span class="ot">=</span> runPromptTM parseFoo3 <span class="op">$</span> \k <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    env <span class="ot">&lt;-</span> lookupEnv k</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="op">$</span> <span class="kw">case</span> env <span class="kw">of</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Left</span> (<span class="dt">MENotFound</span> k)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Just</span> v  <span class="ot">-&gt;</span> <span class="dt">Right</span> v</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a><span class="co">-- Fulfill the prompt through user input</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="ot">throughStdIO ::</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">MyError</span> <span class="dt">Foo</span>)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>throughStdIO <span class="ot">=</span> interactPT parseFoo3</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="co">-- Fulfill the prompt through user input; count blank responses as &quot;not found&quot;</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a><span class="ot">throughStdIOBlankIsError ::</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">MyError</span> <span class="dt">Foo</span>)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>throughStdIOBlankIsError <span class="ot">=</span> runPromptTM parseFoo3 <span class="op">$</span> \k <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">putStrLn</span> k</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    resp <span class="ot">&lt;-</span> <span class="fu">getLine</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="op">$</span> <span class="kw">if</span> <span class="fu">null</span> resp</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>      <span class="kw">then</span> <span class="dt">Left</span> (<span class="dt">MENotFound</span> k)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>      <span class="kw">else</span> <span class="dt">Right</span> resp</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a><span class="co">-- Fulfill the prompt purely through a Map lookup</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a><span class="ot">throughMap ::</span> <span class="dt">M.Map</span> <span class="dt">Key</span> <span class="dt">Val</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">MyError</span> <span class="dt">Foo</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>throughMap m <span class="ot">=</span> runPromptT parseFoo3 <span class="op">$</span> \k <span class="ot">-&gt;</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> M.lookup k m <span class="kw">of</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Left</span> (<span class="dt">MENotFound</span> k)</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Just</span> v  <span class="ot">-&gt;</span> <span class="dt">Right</span> v</span></code></pre></div>
<p>Hope you enjoy! Please feel free to leave a comment, find me on <a href="https://twitter.com/mstk" title="Twitter">twitter</a>, leave an issue on the <a href="https://github.com/mstksg/prompt">github</a>, etc. — and I’m usually on freenode’s <em>#haskell</em> as <em>jle`</em> if you have any questions!</p>
<h2 id="comparisons">Comparisons</h2>
<p>To lay it all on the floor,</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">PromptT</span> a b t r <span class="ot">=</span> <span class="dt">PromptT</span> {<span class="ot"> runPromptTM ::</span> <span class="kw">forall</span> m<span class="op">.</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> m (t b)) <span class="ot">-&gt;</span> m (t r) }</span></code></pre></div>
<p>There is admittedly a popular misconception that I’ve seen going around that equates this sort of type to <code>Free</code> from the <em>free</em> package. However, <code>Free</code> doesn’t really have anything significant to do with this. Sure, you might be able to generate this type by using <code>FreeT</code> over a specifically chosen Functor, but…this is the case for literally any Monad ever, so that doesn’t really mean much :)</p>
<p>It’s also unrelated in this same manner to <code>Prompt</code> from the <em>MonadPrompt</em> package, and <code>Program</code> from <em>operational</em> too.</p>
<p>One close relative to this type is <code>forall m. ReaderT (a -&gt; m b) m r</code>, where <code>prompt k = ReaderT ($ k)</code>. This is more or less equivalent to <code>Prompt</code>, but still can’t do the things that <code>PromptT</code> can do without a special instance of Monad.</p>
<p>This type is also similar in structure to <code>Bazaar</code>, from the <em>lens</em> package. The biggest difference that makes <code>Bazaar</code> unusable is because the RankN constraint is only <code>Applicative</code>, not <code>Monad</code>, so a <code>Monad</code> instance is impossible. Ignoring that (or if it’s okay for you to only use the <code>Applicative</code> instance), <code>Bazaar</code> forces the “prompting effect” to take place in the same context as the <code>Traversable</code> <code>t</code>…which really defeats the purpose of this whole thing in the first place (the idea is to be able to separate your prompting effect from your application logic). If the <code>Traversable</code> you want to transform has a “monad transformer” version, then you can somewhat simulate <code>PromptT</code> for that specifc <code>t</code> with the transformer version.</p>
<p>It’s also somewhat similar to the <code>Client</code> type from <em>pipes</em>, but it’s also a bit tricky to use that with a different effect type than the logic <code>Traversable</code>, as well…so it has a lot of the same difference as <code>Bazaar</code> here.</p>
<p>But this type is common/simple enough that I’m sure someone has it somewhere in a library that I haven’t been able to find. If you find it, let me know!</p></div><footer><hr><div class="copy-content"><p>Hi, thanks for reading! You can reach me via email at <a href="mailto:justin@jle.im" class="email">justin@jle.im</a>, or at twitter at <a href="https://twitter.com/mstk">@mstk</a>! This post and all others are published under the <a href="https://creativecommons.org/licenses/by-nc-nd/3.0/">CC-BY-NC-ND 3.0</a> license. Corrections and edits via pull request are welcome and encouraged at <a href="https://github.com/mstksg/inCode">the source repository</a>.</p>
<p>If you feel inclined, or this post was particularly helpful for you, why not consider <a href="https://www.patreon.com/justinle/overview">supporting me on Patreon</a>, or a <a href="bitcoin:3D7rmAYgbDnp4gp4rf22THsGt74fNucPDU">BTC donation</a>? :)</p></div><div class="clear"></div><ul class="entry-series"></ul><ul class="tag-list"><li><a href="https://blog.jle.im/entries/tagged/functional-programming.html" class="tag-a-tag">#functional programming</a></li><li><a href="https://blog.jle.im/entries/tagged/haskell.html" class="tag-a-tag">#haskell</a></li><li><a href="https://blog.jle.im/entries/tagged/monads.html" class="tag-a-tag">#monads</a></li><li><a href="https://blog.jle.im/entries/category/@haskell.html" class="tag-a-category">@HASKELL</a></li><li><a href="https://blog.jle.im/entries/category/@projects.html" class="tag-a-category">@PROJECTS</a></li></ul><aside class="social-buttons"><div class="addthis_toolbox addthis_default_style addthis-buttons"><a class="addthis_button_facebook_like" fb:like:layout="button_count"></a><a class="addthis_button_tweet"></a><a class="addthis_button_google_plusone" g:plusone:size="medium"></a><a class="addthis_counter addthis_pill_style"></a></div><div class="custom-social-buttons"><div class="custom-social-button"><a href="https://www.reddit.com/submit" onclick="window.location = &#39;https://www.reddit.com/submit?url=&#39;+ encodeURIComponent(window.location); return false"><img src="https://www.reddit.com/static/spreddit7.gif" alt="submit to reddit"></a></div></div></aside><nav class="next-prev-links"><ul><li class="prev-entry-link">&larr; <a href="https://blog.jle.im/entry/mtl-is-not-a-monad-transformer-library.html">mtl is Not a Monad Transformer Library</a> (Previous)</li><li class="next-entry-link">(Next) <a href="https://blog.jle.im/entry/blog-rewrite-with-hakyll-and-purescript.html">Blog Rewrite with Hakyll and Purescript</a> &rarr;</li></ul></nav></footer></article><div class="post-entry"><div class="tile"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://blog.jle.im/entry/introducing-the-prompt-library.html';
    this.page.identifier = 'prompt';
};
(function() {
    var d = document, s = d.createElement('script');
    s.src = '//incode.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a><br></noscript><a href="http://disqus.com" class="dsq-brlink">Comments powered by <span class="logo-disqus">Disqus</span></a></div></div></div></div></div><div id="footer-container"><div id="footer-content"><div class="tile"><div class="footer-copyright">&copy; 2020 Justin Le <span class="license-link">(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/" class="license">CC-BY-NC-ND 3.0</a>)</span></div><div class="footer-follow social-follows"><ul class="social-follows-list"><li><ul class="social-follows-list-social"><li><a class="social-follow-twitter" title="Follow me on Twitter!" href="https://twitter.com/intent/user?user_id=mstk" onclick="window.open(
  &#39;http://twitter.com/intent/user?user_id=907281&#39;,
  &#39;facebook-share-dialog&#39;,
  &#39;width=550,height=520&#39;);
return false;
">Twitter</a></li><li><a class="social-follow-github" title="Fork me on Github!" href="https://github.com/mstksg">Github</a></li><li><a class="social-follow-twitch" title="Watch me on Twitch!" href="https://www.twitch.tv/justin_l">Twitch</a></li><li><a class="social-follow-patreon" title="Support me on Patreon!" href="https://www.patreon.com/justinle/overview">Patreon</a></li><li><a class="social-follow-gplus" title="Add me on Google+!" href="https://plus.google.com/+JustinLe">Google+</a></li><li><a class="social-follow-keybase" title="Track me on Keybase!" href="https://keybase.io/mstksg">Keybase</a></li><li><a class="social-follow-linkedin" title="Connect with me on LinkedIn!" href="https://linkedin.com/in/lejustin">LinkedIn</a></li><li><a class="social-follow-bitcoin" title="Donate via bitcoin!" href="bitcoin:3D7rmAYgbDnp4gp4rf22THsGt74fNucPDU">Bitcoin</a></li></ul></li><li><ul class="social-follows-list-site"><li><a class="social-follow-rss" title="Subscribe to my RSS Feed!" href="http://feeds.feedburner.com/incodeblog">RSS</a></li><li><a class="social-follow-email" title="Subscribe to the mailing list!" href="https://feedburner.google.com/fb/a/mailverify?loc=en_US&amp;uri=incodeblog">Mailing list</a></li></ul></li></ul></div></div></div></div></body></html>