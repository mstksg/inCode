<!DOCTYPE HTML>
<html><head><title>&quot;Five Point Haskell&quot; Part 3: Limited Atonement · in Code</title><meta name="description" content="Weblog of Justin Le, covering various adventures in programming and explorations in the worlds of computation physics, and knowledge.
"><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><meta name="flattr:id" content="3p9jqr"><meta property="og:site_name" content="in Code"><meta property="og:description" content="Hi! We’re in Part 3 of Five-Point Haskell! I’ve been trying to build a framework to describe how I write maintainable and effective Haskell and also highlight anti-principles I reject, and this the third part of that framework. In Total Depravity, we talked about how the failure of mental context windows is always only a matter of time, and how to use types defensively in that light. In Unconditional Election, we talked about how mathematical properties ensure the behavior of our instantiations regardless of any foreseen merit of the implementations. Of course, real code doesn’t just live in an ivory tower of perfect, clean pure abstractions. In some sense, it’s where all of the theory meets practice and finally becomes useful. The goal of Haskell isn’t universal purity: it’s about the correct balance between the impure and pure, and how the existence of one enriches the other. This is Limited Atonement. Limited Atonement: Every domain has a clean line between what is pure and what is not. Declarations of purity are perfectly effective. Impurity is not a failure, but an intentional boundary that gives purity its very meaning.Therefore, in every domain, find that beautiful line. Be intentional: let how you treat the impure give meaning to the limited yet definite purity."><meta property="og:type" content="article"><meta property="og:title" content="&quot;Five Point Haskell&quot; Part 3: Limited Atonement"><meta property="og:image" content="https://blog.jle.im/img/site_logo.jpg"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://blog.jle.im/entry/five-point-haskell-part-3-limited-atonement.html"><meta name="twitter:card" content="summary"><meta name="twitter:creator:id" content="mstk"><link rel="author" href="https://plus.google.com/107705320197444500140"><link rel="alternate" type="application/rss+xml" title="in Code (RSS Feed)" href="http://feeds.feedburner.com/incodeblog"><link rel="canonical" href="https://blog.jle.im/entry/five-point-haskell-part-3-limited-atonement.html"><link href="https://blog.jle.im/favicon.ico" rel="shortcut icon"><link href="https://blog.jle.im/css/toast.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/font.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/main.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/page/entry.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/pygments.css" rel="stylesheet" type="text/css"><script type="text/javascript">var page_data = {};
var disqus_shortname='incode';
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-443711-8', 'jle.im');
ga('send', 'pageview');
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id="MathJax-script" async="" src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js"></script><script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5234d67a6b68dcd4"></script><script type="text/javascript" src="https://blog.jle.im/js/page/entry_toc.js"></script><script type="text/javascript" src="https://blog.jle.im/js/disqus_count.js"></script><script type="text/javascript" src="https://blog.jle.im/js/social.js"></script><script type="text/javascript" src="https://blog.jle.im/js/jquery/jquery.toc.js"></script><script type="text/javascript" src="https://blog.jle.im/purescript/entry.js"></script></head><body><div id="fb-root"><script>(function(d, s, id) {
 var js, fjs = d.getElementsByTagName(s)[0];
 if (d.getElementById(id)) return;
 js = d.createElement(s); js.id = id;
 js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=641852699171929";
 fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script></div><div id="header-container"><div id="navbar-container" class="tile"><nav id="navbar-content"><div class="nav-info"><h1 class="site-title"><a href="https://blog.jle.im/" class="nav-title">in Code</a></h1><span class="nav-author">Justin Le</span></div><ul class="nav-links"><li><a href="https://blog.jle.im/">home</a></li><li><a href="https://blog.jle.im/entries.html">archives</a></li><li><a href="https://cv.jle.im">cv</a></li><div class="clear"></div></ul></nav></div><div id="header-content"></div></div><div id="body-container" class="container"><div id="main-container" class="grid"><div class="entry-section unit span-grid" role="main"><article class="tile article"><header><div class="unposted-banner">Unposted entry</div><h1 id="title">&quot;Five Point Haskell&quot; Part 3: Limited Atonement</h1><p class="entry-info">by <a class="author" href="https://blog.jle.im/">Justin Le</a></p><p><span class="source-info"><a class="source-link" href="https://github.com/mstksg/inCode/tree/master/copy/entries/five-point-haskell-3.md">Source</a><span class="info-separator"> &diams; </span><a class="source-link" href="https://github.com/mstksg/inCode/tree/gh-pages/entry/five-point-haskell-part-3-limited-atonement.md">Markdown</a><span class="info-separator"> &diams; </span><a class="source-link" href="https://blog.jle.im/entry/five-point-haskell-part-3-limited-atonement.tex">LaTeX</a><span class="info-separator"> &diams; </span></span>Posted in <a href="https://blog.jle.im/entries/category/@haskell.html" class="tag-a-category" title="Functional, pure, non-strict, statically and strongly typed, natively
compiled...really just the king of great languages.
">Haskell</a><span class="info-separator"> &diams; </span><a class="comment-link" href="#disqus_thread">Comments</a></p></header><hr><aside class="contents-container"><h5 id="contents-header">Contents</h5><div id="toc"></div></aside><div class="main-content copy-content"><p>Hi! We’re in Part 3 of <em><a href="https://blog.jle.im/entries/series/+five-point-haskell.html">Five-Point Haskell</a></em>! I’ve been trying to build a framework to describe how I write maintainable and effective Haskell and also highlight anti-principles I reject, and this the third part of that framework.</p>
<p>In <a href="https://blog.jle.im/entry/five-point-haskell-part-1-total-depravity.html">Total Depravity</a>, we talked about how the failure of mental context windows is always only a matter of time, and how to use types defensively in that light. In <a href="https://blog.jle.im/entry/five-point-haskell-part-2-unconditional-election.html">Unconditional Election</a>, we talked about how mathematical properties ensure the behavior of our instantiations regardless of any foreseen merit of the implementations.</p>
<p>Of course, real code doesn’t just live in an ivory tower of perfect, clean pure abstractions. In some sense, it’s where all of the theory meets practice and finally becomes useful. The goal of Haskell isn’t universal purity: it’s about the correct balance between the impure and pure, and how the existence of one enriches the other. This is <strong>Limited Atonement</strong>.</p>
<blockquote>
<p>Limited Atonement: Every domain has a clean line between what is pure and what is not. Declarations of purity are perfectly effective. Impurity is not a failure, but an intentional boundary that gives purity its very meaning.</p>
<p>Therefore, in every domain, find that beautiful line. Be intentional: let how you treat the impure give meaning to the limited yet definite purity.</p>
</blockquote>
<h2 id="the-case-for-purity">The Case for Purity</h2>
<p>Before we can start diving into the nuances, let’s actually remind ourselves why it’s important to put purity in the type system in the first place. After all, this isn’t exactly a widely accepted “value” in the wider programming world.</p>
<p>If you’ve encountered Haskell in popular culture, it might have been <a href="https://xkcd.com/1312/">in this xkcd comic</a>:</p>
<figure>
<img src="/img/entries/five-point-haskell/xkcd-1312-haskell.png" title="xkcd --- Haskell" style="width:50%;height:auto;" alt="xkcd — Haskell" />
<figcaption aria-hidden="true">xkcd — Haskell</figcaption>
</figure>
<p>There’s some truth to it, but there’s also some truth to the quote that “Haskell is the best imperative language”: we understand that in order to conquer the beast, we must first <em>name</em> it. If your code has no way to tell the difference between code that does IO and code that does not, you really have no hope in reasoning with <em>anything</em>.</p>
<p>If you have some familiarity with the topic (or have read my <a href="https://blog.jle.im/entry/first-class-statements.html">past</a> <a href="https://blog.jle.im/entry/the-compromiseless-reconciliation-of-i-o-and-purity.html">posts</a>), <em>technically</em> we can look at IO in Haskell as still “pure” in the sense that we are purely constructing an IO action. That is, <code>putStrLn :: String -&gt; IO ()</code> purely returns the same <code>IO ()</code> action every single time. <code>readIORef :: IORef a -&gt; IO a</code> returns the same <code>IO a</code> action every time, even if the <code>a</code> itself might be different every time you execute it.</p>
<p>While <em>technically</em> correct, this framing is somewhat facetious (an accusation I fully accept) and doesn’t really get to the point of what impurity really is. It’s not about pure or impure <em>functions</em> (<code>-&gt;</code>), it’s about pure or impure <em>logic</em>, and being able to represent that in the type system.</p>
<p>Remember in <a href="https://blog.jle.im/entry/five-point-haskell-part-2-unconditional-election.html">Part 2</a>, we compared and contrasted similar type signatures in Haskell and Java</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ot">foo ::</span> <span class="kw">forall</span> a<span class="op">.</span> a <span class="ot">-&gt;</span> a</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="op">&lt;</span>T<span class="op">&gt;</span> T <span class="fu">foo</span><span class="op">(</span>T x<span class="op">)</span></span></code></pre></div>
<p>In order to even <em>start talking</em> about all the cool things about parametric polymorphism, etc., we had to add the caveat “Assume no IO, assume no mutation of arguments”.</p>
<p>Once we put them side-by-side:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ot">mkString ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ot">mkStringIO ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">String</span></span></code></pre></div>
<p>Instantly we understand that the first function must:</p>
<ol type="1">
<li>Always return the same string for any <code>Int</code></li>
<li>Not perform any IO during the computation</li>
<li>Cannot modify the environment</li>
</ol>
<p>whereas the second has no such guarantee. We have no such expressiveness in</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="bu">String</span> <span class="fu">mkString</span><span class="op">(</span><span class="bu">Integer</span> x<span class="op">)</span></span></code></pre></div>
<p>which could presumably call out to the network, use a random generator to produce the string, or modify some internal counter every time it is called.</p>
<p>On one hand, you might end up needlessly introducing overhead and complexity in your language, akin to the <a href="https://journal.stuffwithstuff.com/2015/02/01/what-color-is-your-function/">colored function debate</a>. Sneaking in IO in a deeply nested function requires completely propagating this to every caller up to the very top.</p>
<p>But on the other hand…maybe it <em>should</em>? If some deeply nested sub-function call in your function does IO, this seems exactly the situation you <em>would</em> want such a change to be flagged by the compiler. The fact that impurity must bubble up is a feature, not a bug.</p>
<p>One day in traffic school, I remember a student asking the teacher a question, “If there is nobody at the 4-way stop sign intersection, do I still have to stop?”</p>
<p>The teacher answered, “My child, if you don’t see the other person at a 4-way stop, that is exactly the situation you <em>should</em> be stopping in.”</p>
<p>And, so what? Why do we care in the first place, if the purpose of our function is to do IO anyway?</p>
<p>Well:</p>
<ul>
<li><p>You should care about unmarked IO if you care about global variables. IO is the ultimate unrestricted global variable: any <code>IO</code> action can freely modify the process environment or the file system: it can call <code>setEnv</code> or <code>lookupEnv</code> against global variables that can be access across your entire process.</p></li>
<li><p>You should care about IO if you care about memoization: we can safely cache <code>mkString 42</code> and <code>mkString 67</code> forever, without worrying that every time we access them they should have been different numbers.</p></li>
<li><p>You should care about unmarked IO if you care about safe refactoring and common subexpression elimination. Consider populating data with <code>mkString</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ot">mkUser ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">User</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>mkUser n <span class="ot">=</span> <span class="dt">User</span> { name <span class="ot">=</span> mkString n, ident <span class="ot">=</span> mkString n }</span></code></pre></div>
<p>This <em>should</em> be the same as:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ot">mkUser ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">User</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>mkUser n <span class="ot">=</span> <span class="dt">User</span> { name <span class="ot">=</span> nameAndIdent, ident <span class="ot">=</span> nameAndIdent }</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    nameAndIdent <span class="ot">=</span> mkString n</span></code></pre></div>
<p>In many cases, this could be more performant and save space. You might only have to allocate only a single heap object instead of multiple. However, this is <em>not</em> a valid program optimization if <code>mkString</code> could do IO! Calling it twice could give different results, or affect the environment in different ways, than calling it once!</p></li>
<li><p>You should care about unmarked IO if you care about laziness. Granted, this requires a desire for laziness in the first place (so, Ocaml users, you’re off the hook). But if you can imagine:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ot">mkUser ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">User</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>mkUser n <span class="ot">=</span> <span class="dt">User</span> { name <span class="ot">=</span> b, ident <span class="ot">=</span> a }</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">=</span> mkString n</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">=</span> mkString (n <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    c <span class="ot">=</span> mkString (n <span class="op">+</span> <span class="dv">3</span>)</span></code></pre></div>
<p>What…what order are those <code>mkString</code>s called, in a lazy language? If there was unmarked IO, the order <em>does</em> matter. If there wasn’t, they <em>can’t</em>. And <code>c</code> could not even be freely discarded if there was unmarked IO.</p></li>
<li><p>You should care about IO if you care about concurrency. Imagine parallel mapping over multiple numbers:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ot">myStrings ::</span> [<span class="dt">String</span>]</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>myStrings <span class="ot">=</span> parMap mkString [<span class="dv">1</span><span class="op">..</span><span class="dv">100</span>]</span></code></pre></div>
<p>If <code>mkString</code> had unmarked IO and accessed locks or mutexes, this could easily be a race condition. But it doesn’t, so we can guarantee no race conditions. We can also be assured that the order in which we schedule our threads will have no affect on the result.</p></li>
<li><p>You should care about unmarked IO if you care about testing. Because it states no external dependency, you can test <code>mkString</code> without requiring any sandboxing, isolation, or extra interleaving interactions with other functions.</p></li>
</ul>
<h2 id="the-real-worlds">The Real Worlds</h2>
<h3 id="io">IO</h3>
<h3 id="st">ST</h3>
<h3 id="stm">STM</h3>
<h3 id="scoped-environments">Scoped Environments</h3>
<h2 id="the-simulated-worlds">The Simulated Worlds</h2>
<h3 id="pure-short-circuiting">Pure Short Circuiting</h3>
<h3 id="reader">Reader</h3>
<h3 id="state">State</h3>
<h2 id="the-bespoke-world">The Bespoke World</h2>
<h3 id="free">Free</h3>
<h3 id="tagless-final">Tagless Final</h3>
<h3 id="extensible-effects">Extensible Effects</h3>
<h3 id="wait-did-i-just-write-a-monad-tutorial">Wait, did I just write a Monad Tutorial?</h3></div><footer><hr><div class="copy-content"><p>Hi, thanks for reading! You can reach me via email at <a href="mailto:justin@jle.im" class="email">justin@jle.im</a>, or at twitter at <a href="https://twitter.com/mstk">@mstk</a>! This post and all others are published under the <a href="https://creativecommons.org/licenses/by-nc-nd/3.0/">CC-BY-NC-ND 3.0</a> license. Corrections and edits via pull request are welcome and encouraged at <a href="https://github.com/mstksg/inCode">the source repository</a>.</p>
<p>If you feel inclined, or this post was particularly helpful for you, why not consider <a href="https://www.patreon.com/justinle/overview">supporting me on Patreon</a>, or a <a href="bitcoin:3D7rmAYgbDnp4gp4rf22THsGt74fNucPDU">BTC donation</a>? :)</p></div><div class="clear"></div><ul class="entry-series"><li><div>This entry is a part of a series called <b>&quot;Five-Point Haskell&quot;</b>.  Find the rest of the entries in this series at its <a href="https://blog.jle.im/entries/series/+five-point-haskell.html" class="tag-a-series" title="+Five-Point Haskell"> series history</a>.</div></li></ul><ul class="tag-list"><li><a href="https://blog.jle.im/entries/tagged/functional-programming.html" class="tag-a-tag">#functional programming</a></li><li><a href="https://blog.jle.im/entries/tagged/type-safety.html" class="tag-a-tag">#type safety</a></li><li><a href="https://blog.jle.im/entries/category/@haskell.html" class="tag-a-category">@HASKELL</a></li><li><a href="https://blog.jle.im/entries/series/+five-point-haskell.html" class="tag-a-series">+Five-Point Haskell</a></li></ul><aside class="social-buttons"><div class="addthis_toolbox addthis_default_style addthis-buttons"><a class="addthis_button_facebook_like" fb:like:layout="button_count"></a><a class="addthis_button_tweet"></a><a class="addthis_button_google_plusone" g:plusone:size="medium"></a><a class="addthis_counter addthis_pill_style"></a></div><div class="custom-social-buttons"><div class="custom-social-button"><a href="https://www.reddit.com/submit" onclick="window.location = &#39;https://www.reddit.com/submit?url=&#39;+ encodeURIComponent(window.location); return false"><img src="https://www.reddit.com/static/spreddit7.gif" alt="submit to reddit"></a></div></div></aside><nav class="next-prev-links"><ul><li class="next-entry-link">(Next) <a href="https://blog.jle.im/entry/introducing-in-code.html">Introducing &quot;in Code&quot;!</a> &rarr;</li></ul></nav></footer></article><div class="post-entry"><div class="tile"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://blog.jle.im/entry/five-point-haskell-part-3-limited-atonement.html';
    this.page.identifier = 'five-point-haskell-3';
};
(function() {
    var d = document, s = d.createElement('script');
    s.src = '//incode.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a><br></noscript><a href="http://disqus.com" class="dsq-brlink">Comments powered by <span class="logo-disqus">Disqus</span></a></div></div></div></div></div><div id="footer-container"><div id="footer-content"><div class="tile"><div class="footer-copyright">&copy; 2020 Justin Le <span class="license-link">(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/" class="license">CC-BY-NC-ND 3.0</a>)</span></div><div class="footer-follow social-follows"><ul class="social-follows-list"><li><ul class="social-follows-list-social"><li><a class="social-follow-twitter" title="Follow me on Twitter!" href="https://twitter.com/intent/user?user_id=mstk" onclick="window.open(
  &#39;http://twitter.com/intent/user?user_id=907281&#39;,
  &#39;facebook-share-dialog&#39;,
  &#39;width=550,height=520&#39;);
return false;
">Twitter</a></li><li><a class="social-follow-github" title="Fork me on Github!" href="https://github.com/mstksg">Github</a></li><li><a class="social-follow-twitch" title="Watch me on Twitch!" href="https://www.twitch.tv/justin_l">Twitch</a></li><li><a class="social-follow-patreon" title="Support me on Patreon!" href="https://www.patreon.com/justinle/overview">Patreon</a></li><li><a class="social-follow-gplus" title="Add me on Google+!" href="https://plus.google.com/+JustinLe">Google+</a></li><li><a class="social-follow-keybase" title="Track me on Keybase!" href="https://keybase.io/mstksg">Keybase</a></li><li><a class="social-follow-linkedin" title="Connect with me on LinkedIn!" href="https://linkedin.com/in/lejustin">LinkedIn</a></li><li><a class="social-follow-bitcoin" title="Donate via bitcoin!" href="bitcoin:3D7rmAYgbDnp4gp4rf22THsGt74fNucPDU">Bitcoin</a></li></ul></li><li><ul class="social-follows-list-site"><li><a class="social-follow-rss" title="Subscribe to my RSS Feed!" href="http://feeds.feedburner.com/incodeblog">RSS</a></li><li><a class="social-follow-email" title="Subscribe to the mailing list!" href="https://feedburner.google.com/fb/a/mailverify?loc=en_US&amp;uri=incodeblog">Mailing list</a></li></ul></li></ul></div></div></div></div></body></html>